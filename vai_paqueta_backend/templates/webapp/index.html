{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#388E3C">
  <meta name="background-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Vai Paquetá">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Vai Paquetá | Web App</title>
  <link rel="manifest" href="{% url 'webapp_manifest' %}">
  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'pwa/icon-180.png' %}">
  <link rel="icon" type="image/png" sizes="192x192" href="{% static 'pwa/icon-192.png' %}">
  <link rel="icon" type="image/png" sizes="512x512" href="{% static 'pwa/icon-512.png' %}">
  <link rel="stylesheet" href="{% static 'landing/assets/css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'landing/assets/css/LineIcons.2.0.css' %}">
  <link rel="stylesheet" href="{% static 'landing/assets/css/main.css' %}">
  <link rel="stylesheet" href="{% static 'leaflet/leaflet.css' %}">
  <style>
    :root {
      --vp-primary: #388E3C;
      --vp-bg: #f9f9f9;
      --vp-dark: #081828;
      --vp-muted: #888;
      --bs-success: #388E3C;
      --bs-success-rgb: 56, 142, 60;
    }
    body { background: var(--vp-bg); color: var(--vp-muted); font-family: "Inter", sans-serif; }
    .webapp-header {
      position: relative;
      background: #fff;
      border-bottom: 1px solid #eef2f7;
      z-index: 2000;
      padding: 4px 0;
      box-shadow: none;
    }
    .webapp-header.sticky {
      position: relative;
      box-shadow: none;
      z-index: 2000;
    }
    .webapp-header .navbar {
      min-height: 64px;
    }
    .webapp-header .navbar-brand {
      padding: 0;
      margin: 0;
    }
    .webapp-header .navbar-brand img {
      height: 64px;
      width: auto;
      max-height: 64px;
    }
    .webapp-header .navbar .navbar-nav .nav-item a {
      color: #0c1a12;
      font-weight: 600;
      padding: 6px 8px;
    }
    .webapp-header .navbar .navbar-nav .nav-item a.active {
      color: #1f5f2c;
    }
    .webapp-header .navbar .navbar-nav .nav-item a::before,
    .webapp-header .navbar .navbar-nav .nav-item a::after {
      display: none;
    }
    .webapp-header .mobile-menu-btn .toggler-icon {
      background-color: #0c1a12;
    }
    .webapp-header .button .btn {
      border: 2px solid var(--vp-primary);
      color: var(--vp-primary);
      background: transparent;
    }
    .webapp-header .button .btn:hover {
      background: var(--vp-primary);
      color: #fff;
    }
    .leaflet-container {
      z-index: 1;
    }
    .webapp-main {
      padding-top: 16px;
    }
    @media (max-width: 767px) {
      .webapp-main {
        padding-top: 12px;
      }
    }
    .vp-card {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 18px 20px;
      margin-bottom: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.04);
    }
    .vp-title { color: var(--vp-dark); font-weight: 600; }
    .vp-badge { background: var(--vp-primary); color: #fff; padding: 6px 10px; border-radius: 999px; font-size: 12px; }
    .vp-section { padding: 60px 0; }
    .vp-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
    .vp-label { font-weight: 600; margin-bottom: 4px; color: var(--vp-dark); }
    .vp-muted { color: var(--vp-muted); font-size: 14px; }
    pre { background: #0b1724; color: #cfe3ff; padding: 12px; border-radius: 10px; font-size: 13px; overflow-x: auto; }
    #map { width: 100%; height: 360px; border-radius: 6px; border: 1px solid #eee; }
    .nav-pills .nav-link.active { background: var(--vp-primary); }
    /* Login shell */
    .vp-login-shell { min-height: 70vh; display: flex; align-items: center; }
    .vp-login-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 18px; padding: 28px; box-shadow: 0 15px 60px rgba(0,0,0,0.06); width: 100%; }
    .vp-login-hero { background: linear-gradient(135deg, rgba(56,142,60,0.12), rgba(56,142,60,0.05)); border-radius: 14px; padding: 20px; height: 100%; }
    .vp-login-hero ul { padding-left: 18px; }
    .vp-login-hero li { margin-bottom: 8px; color: #1f2933; }
    .vp-toggle { background: #f1f5f9; border-radius: 10px; padding: 6px; display: inline-flex; gap: 6px; }
    .vp-toggle button { border: none; background: transparent; padding: 8px 14px; border-radius: 8px; font-weight: 600; color: #1f2933; }
    .vp-toggle button.active { background: #fff; color: #0c1a12; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
    .vp-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 1050; display: none; align-items: center; justify-content: center; }
    .vp-modal { background: #fff; border-radius: 14px; padding: 20px; max-width: 720px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
    .vp-modal h5 { margin: 0; }
    #payment-warning-modal { z-index: 1060; }
    #error-modal { z-index: 1070; }
    .vp-modal-error { border: 1px solid rgba(220, 38, 38, 0.2); }
    .vp-badge-error { background: #dc2626; }
    #ride-modal-map,
    #driver-ride-modal-map { width: 100%; height: 260px; border-radius: 10px; border: 1px solid #e5e7eb; margin-top: 10px; }
    .vp-modal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 12px; }
    .vp-modal-item { background: #f8fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px 14px; }
    .vp-modal-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.06em; color: #6b7280; margin-bottom: 6px; }
    .vp-modal-value { font-weight: 600; color: #0c1a12; word-break: break-word; }
    .vp-modal-sub { margin-top: 4px; color: #475569; font-size: 15px; word-break: break-word; }
    .vp-modal-inline { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .vp-modal-whatsapp { padding: 4px 10px; font-size: 12px; }
    .vp-modal-status { background: linear-gradient(135deg, rgba(56,142,60,0.18), rgba(56,142,60,0.05)); border: 1px solid rgba(56,142,60,0.25); grid-column: 1 / -1; }
    .vp-modal-status .vp-modal-value { font-size: 20px; font-weight: 700; }
    .vp-modal-progress { height: 8px; background: #e5e7eb; border-radius: 999px; overflow: hidden; margin-top: 8px; }
    .vp-modal-progress-bar { height: 100%; width: 0%; background: var(--vp-primary); transition: width 0.25s ease; }
    .vp-modal-progress-hint { font-size: 13px; color: #2e7d32; margin-top: 6px; }
    .vp-modal-progress--warn .vp-modal-progress-bar { background: #f59e0b; }
    .vp-modal-progress-hint--warn { color: #b45309; }
    .vp-progress {
      height: 6px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      opacity: 0;
      transition: opacity 0.2s ease;
      margin-top: 8px;
    }
    .vp-progress.is-active { opacity: 1; }
    .vp-progress-bar {
      height: 100%;
      width: 0%;
      background: var(--vp-primary);
      transition: width 0.4s ease;
    }
    @media (max-width: 991px) {
      .webapp-header .navbar-brand img {
        height: 56px;
        width: auto;
        max-height: 56px;
      }
      .button.add-list-button {
        width: 100%;
        margin-top: 10px;
        display: flex;
        justify-content: center;
      }
      .button.add-list-button .btn {
        width: 100%;
        text-align: center;
      }
    }
    @media (max-width: 767px) {
      body {
        font-size: 16px;
      }
      .navbar-collapse {
        background: #fff;
        border-radius: 12px;
        padding: 12px 14px;
        margin-top: 10px;
        box-shadow: 0 10px 24px rgba(0,0,0,0.08);
      }
      .nav-pills {
        flex-direction: column;
        gap: 8px;
      }
      .nav-pills .nav-link {
        width: 100%;
        text-align: center;
      }
      .vp-login-shell {
        min-height: auto;
      }
      .vp-login-card {
        padding: 20px;
      }
      .vp-login-hero {
        padding: 16px;
      }
      .vp-toggle {
        width: 100%;
        justify-content: space-between;
      }
      .vp-toggle button {
        flex: 1;
      }
      .vp-grid {
        grid-template-columns: 1fr;
      }
      .vp-card {
        padding: 16px;
      }
      #map {
        height: 240px;
      }
      #ride-modal-map,
      #driver-ride-modal-map {
        height: 200px;
      }
      .vp-modal {
        max-height: 85vh;
        overflow-y: auto;
      }
      .vp-modal-grid {
        grid-template-columns: 1fr;
      }
      input,
      select,
      textarea {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <header class="header navbar-area webapp-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-12">
          <div class="nav-inner">
            <nav class="navbar navbar-expand-lg">
              <a class="navbar-brand" href="/app/">
                <img
                  src="{% static 'landing/assets/images/logo/logo-collor.png' %}"
                  data-logo-top="{% static 'landing/assets/images/logo/logo-collor.png' %}"
                  data-logo-sticky="{% static 'landing/assets/images/logo/logo-collor.png' %}"
                  alt="Vai Paquetá">
              </a>
              <button class="navbar-toggler mobile-menu-btn" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="toggler-icon"></span>
                <span class="toggler-icon"></span>
                <span class="toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse sub-menu-bar" id="navbarSupportedContent">
                <ul id="nav" class="navbar-nav ms-auto">
                  <li class="nav-item">
                    <a href="/app/" class="page-scroll active" aria-label="Ir para o web app">Web App</a>
                  </li>
                  <li class="nav-item">
                    <a href="/" class="page-scroll" aria-label="Ir para a landing">Início</a>
                  </li>
                  <li class="nav-item">
                    <a href="/#download-android" class="page-scroll"
                      aria-label="Ir para baixar Android">Baixar Android</a>
                  </li>
                  <li class="nav-item">
                    <a href="#contato" class="page-scroll" aria-label="Ir para a seção de contato">Contato</a>
                  </li>
                </ul>
              </div>
              <div class="button add-list-button">
                <button class="btn" id="btn-logout" type="button"><i class="lni lni-exit"></i> Sair</button>
              </div>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="webapp-main">
    <div class="container">
    <!-- Autenticação -->
    <div class="vp-section vp-login-shell" id="auth-section">
      <div class="vp-login-card">
        <div class="row g-4">
          <div class="col-lg-5">
            <div class="vp-login-hero h-100">
              <div class="vp-badge mb-2">Faça login para continuar</div>
              <div class="vp-title h4 mb-2">Peça eco-táxi pela web</div>
              <p class="vp-muted">Fluxo simples do app: pedir corrida e acompanhar no mapa.</p>
              <ul class="mt-3">
                <li>Pedir corrida em poucos toques.</li>
                <li>Motorista confirma e você acompanha.</li>
                <li>Mapa com origem, destino e posição.</li>
              </ul>
            </div>
          </div>
          <div class="col-lg-7">
            <div class="vp-card h-100">
              <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div>
                  <div class="vp-title h5 mb-0">Acessar sua conta</div>
                  <div class="vp-muted">Use seu e-mail para entrar ou criar conta.</div>
                </div>
                <div class="vp-toggle" id="auth-toggle">
                  <button data-auth="login" class="active" type="button">Login</button>
                  <button data-auth="register" type="button">Cadastro</button>
                </div>
              </div>
              <div id="auth-login-form">
                <div class="mb-2">
                  <label class="vp-label">E-mail</label>
                  <input class="form-control" id="login-email" placeholder="seu@email.com">
                </div>
                <div class="mb-3">
                  <label class="vp-label">Senha</label>
                  <input class="form-control" type="password" id="login-password" placeholder="mínimo 6 caracteres">
                </div>
                <button class="btn btn-success w-100" id="btn-login">Entrar</button>
              </div>
              <div id="auth-register-form" class="d-none">
                <div class="mb-2 mt-3">
                  <label class="vp-label">Nome</label>
                  <input class="form-control" id="reg-nome" placeholder="Seu nome">
                </div>
                <div class="mb-2">
                  <label class="vp-label">Telefone</label>
                  <div class="row g-2">
                    <div class="col-5 col-md-4">
                      <select class="form-select" id="reg-ddi"></select>
                    </div>
                    <div class="col-7 col-md-8">
                      <input class="form-control" id="reg-telefone" placeholder="DDD + Número" inputmode="numeric">
                    </div>
                  </div>
                  <small class="vp-muted">Selecione o país e informe DDD e número no mesmo campo.</small>
                </div>
                <div class="mb-2">
                  <label class="vp-label">E-mail</label>
                  <input class="form-control" id="reg-email" placeholder="seu@email.com">
                </div>
                <div class="mb-3">
                  <label class="vp-label">Senha</label>
                  <input class="form-control" type="password" id="reg-password" placeholder="mínimo 6 caracteres">
                </div>
                <div class="mb-3">
                  <label class="vp-label">Confirmar senha</label>
                  <input class="form-control" type="password" id="reg-password-confirm" placeholder="repita a senha">
                </div>
                <div class="mb-3 form-check">
                  <input class="form-check-input" type="checkbox" id="reg-terms">
                  <label class="form-check-label" for="reg-terms">
                Li e aceito os <a href="#" id="open-terms-link">Termos de Uso</a> e a
                <a href="/privacidade/" target="_blank" rel="noopener">Política de Privacidade</a>.
              </label>
            </div>
                <button class="btn btn-success w-100" id="btn-register">Criar e entrar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Área logada -->
    <div class="vp-section d-none" id="app-section">
      <div class="vp-card mb-3">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <div>
            <div class="vp-title h5 mb-0">Sessão ativa</div>
            <div class="vp-muted" id="session-user">Carregando...</div>
          </div>
          <span class="vp-badge d-none" id="session-profile-badge"></span>
        </div>
      </div>

      <ul class="nav nav-pills mb-3" id="vp-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link d-none" data-target="#tab-passenger" type="button">Passageiro</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link d-none" data-target="#tab-driver" type="button">Eco-taxista</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-target="#tab-profile" type="button">Perfil</button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- Passageiro -->
        <div id="tab-passenger" class="tab-pane fade d-none">
          <div class="vp-grid">
            <div class="vp-card">
              <div class="vp-title h5 mb-3">Pedir corrida</div>
              <div class="mb-2">
                <label class="vp-label">Origem</label>
                <div class="input-group">
                  <input class="form-control" id="origem-end" list="addresses-list" placeholder="Usar GPS ou escolher endereço">
                  <button class="btn btn-outline-success" id="btn-origem-gps"><i class="lni lni-map-marker"></i></button>
                </div>
                <small class="vp-muted">A origem tenta pegar seu GPS primeiro; se negar permissão, escolha um endereço sugerido.</small>
              </div>
              <div class="mb-3">
                <label class="vp-label">Destino</label>
                <input class="form-control" id="destino-end" list="addresses-list" placeholder="Escolha um endereço de destino">
                <small class="vp-muted">Sugestões vindas do mapa de Paquetá.</small>
              </div>
              <div class="mb-3">
                <label class="vp-label">Lugares</label>
                <select class="form-select" id="passenger-seats">
                  <option value="1">1 pessoa</option>
                  <option value="2">2 pessoas</option>
                </select>
                <small class="vp-muted">Os eco-táxis comportam até 2 lugares.</small>
              </div>
              <input type="hidden" id="origem-lat">
              <input type="hidden" id="origem-lng">
              <input type="hidden" id="destino-lat">
              <input type="hidden" id="destino-lng">
              <datalist id="addresses-list"></datalist>
              <button class="btn btn-success w-100 mt-2" id="btn-solicitar">Solicitar corrida</button>
            </div>

          </div>
        </div>

        <!-- Motorista -->
        <div id="tab-driver" class="tab-pane fade d-none">
          <div class="vp-grid">
            <div class="vp-card">
              <div class="vp-title h5 mb-2">Localização automática</div>
              <p class="vp-muted">Sua posição é enviada automaticamente quando o GPS estiver ativo.</p>
              <div class="mb-2">
                <div class="vp-label">Status</div>
                <div id="driver-gps-status">Aguardando GPS...</div>
                <div class="vp-muted" id="driver-gps-last">Último envio: —</div>
                <div class="vp-muted" id="driver-gps-coords">Posição: —</div>
                <div class="vp-progress" id="driver-gps-progress">
                  <div class="vp-progress-bar" id="driver-gps-progress-bar"></div>
                </div>
              </div>
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-outline-success btn-sm" id="btn-enable-gps">Ativar GPS</button>
                <button class="btn btn-outline-secondary btn-sm" id="btn-toggle-manual">Enviar manualmente</button>
              </div>
              <div class="mt-3 d-none" id="driver-manual-form">
                <div class="mb-2">
                  <label class="vp-label">Localização manual</label>
                  <div class="input-group">
                    <input class="form-control" id="driver-end" list="addresses-list" placeholder="Escolha um endereço">
                    <button class="btn btn-outline-success" id="btn-ping-gps"><i class="lni lni-map-marker"></i></button>
                  </div>
                  <small class="vp-muted">Use um endereço da lista ou o GPS para preencher.</small>
                </div>
                <input type="hidden" id="driver-lat">
                <input type="hidden" id="driver-lng">
                <div class="mb-3">
                  <label class="vp-label">Precisão (m) opcional</label>
                  <input class="form-control" id="ping-precisao" placeholder="10">
                </div>
                <button class="btn btn-success w-100" id="btn-enviar-ping">Enviar ping</button>
              </div>
            </div>

          </div>
        </div>

        <!-- Perfil -->
        <div id="tab-profile" class="tab-pane fade show active">
          <div class="vp-grid">
            <div class="vp-card">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="vp-title h5 mb-0">Dados do usuário</div>
                <span class="vp-badge">Perfil</span>
              </div>
              <div class="mb-2">
                <label class="vp-label">Nome</label>
                <input class="form-control" id="perfil-nome" placeholder="Seu nome">
              </div>
              <div class="mb-2">
                <label class="vp-label">Telefone</label>
                <div class="row g-2">
                  <div class="col-5 col-md-4">
                    <select class="form-select" id="perfil-ddi"></select>
                  </div>
                  <div class="col-7 col-md-8">
                    <input class="form-control" id="perfil-telefone" placeholder="DDD + Número" inputmode="numeric">
                  </div>
                </div>
                <small class="vp-muted">Selecione o país e informe DDD e número no mesmo campo.</small>
              </div>
              <div class="mb-2">
                <label class="vp-label">Tipo do perfil</label>
                <select class="form-select" id="perfil-tipo">
                  <option value="passageiro">Passageiro</option>
                  <option value="ecotaxista">Eco-taxista</option>
                </select>
              </div>
              <button class="btn btn-success w-100" id="btn-update-profile">Salvar perfil</button>
              <button class="btn btn-outline-danger w-100 mt-2" id="btn-delete-account">Excluir conta</button>
            </div>

          </div>
        </div>
      </div>

      <!-- Mapa -->
      <div class="vp-section pt-0">
      <div class="vp-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="vp-title h5 mb-0">Mapa</div>
          <span class="vp-badge">Origem / Destino / Motorista</span>
        </div>
        <div class="vp-muted mb-2" id="map-status">Carregando mapa...</div>
        <div id="map"></div>
      </div>
    </div>
    </div>
  </main>

  <footer class="footer">
    <div class="footer-top">
      <div class="container">
        <div class="row">
          <div class="col-lg-4 col-md-4 col-12">
            <!-- Single Widget -->
            <div class="single-footer f-about">
              <div class="logo">
                <a href="/">
                  <img src="{% static 'landing/assets/images/logo/logo-collor.png' %}" alt="Vai Paquetá">
                </a>
              </div>
              <p>Vai Paquetá é um piloto de mobilidade que conecta passageiros e eco-taxistas na Ilha de Paquetá,
                combinando organização digital com o contato próximo da comunidade.</p>
            </div>
            <!-- End Single Widget -->
          </div>
          <div class="col-lg-8 col-md-8 col-12">
            <div class="row">
              <div class="col-lg-4 col-md-6 col-12">
                <!-- Single Widget -->
                <div class="single-footer f-link">
                  <h3>Aplicativo</h3>
                  <ul>
                    <li><a href="/#features">Como funciona</a></li>
                    <li><a href="/#impacto">Impacto esperado</a></li>
                    <li><a href="/#download-android">Baixar Android</a></li>
                    <li><a href="/privacidade/">Política de Privacidade</a></li>
                  </ul>
                </div>
                <!-- End Single Widget -->
              </div>
              <div class="col-lg-4 col-md-6 col-12">
                <!-- Single Widget -->
                <div class="single-footer f-link">
                  <h3>Projeto</h3>
                  <ul>
                    <li><a href="/privacidade/">Política de Privacidade</a></li>
                  </ul>
                </div>
                <!-- End Single Widget -->
              </div>
              <div class="col-lg-4 col-md-6 col-12">
                <!-- Single Widget -->
                <div class="single-footer f-contact" id="contato">
                  <h3>Fale com a equipe Vai Paquetá</h3>
                  <p>Tem dúvidas, dicas ou encontrou alguma falha no app? Preencha o formulário e retornamos por
                    e-mail ou WhatsApp.</p>
                  <div class="button">
                    <a href="https://forms.gle/fQpn7XDjBTarJkSw7" target="_blank" rel="noopener"
                      class="btn">Abrir formulário</a>
                    <a href="/#features" class="btn btn-alt">Rever como funciona</a>
                  </div>
                </div>
                <!-- End Single Widget -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--/ End Footer Top -->
  </footer>
  <!--/ End Footer Area -->

  <script src="{% static 'landing/assets/js/bootstrap.min.js' %}"></script>
  <script src="{% static 'leaflet/leaflet.js' %}"></script>

  <!-- Modal de corrida aberta (passageiro) -->
  <div class="vp-modal-backdrop" id="ride-modal">
    <div class="vp-modal">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="vp-title mb-0">Corrida em andamento</h5>
        <span class="vp-badge">Passageiro</span>
      </div>
      <div class="vp-muted mb-2">Sua corrida está ativa. Acompanhe o status e o mapa.</div>
      <div id="ride-modal-map"></div>
      <div class="vp-modal-grid" id="ride-modal-body">
        <div class="vp-modal-item vp-modal-status">
          <div class="vp-modal-label">Status</div>
          <div class="vp-modal-value" id="ride-modal-status">Aguardando motorista</div>
          <div class="vp-modal-sub" id="ride-modal-status-hint">Aguardando confirmação do motorista.</div>
          <div class="vp-modal-progress d-none" id="ride-modal-cancel-progress">
            <div class="vp-modal-progress-bar" id="ride-modal-cancel-progress-bar"></div>
          </div>
          <div class="vp-modal-progress-hint d-none" id="ride-modal-cancel-progress-hint"></div>
          <div class="vp-modal-progress vp-modal-progress--warn d-none" id="ride-modal-finalize-progress">
            <div class="vp-modal-progress-bar" id="ride-modal-finalize-progress-bar"></div>
          </div>
          <div class="vp-modal-progress-hint vp-modal-progress-hint--warn d-none" id="ride-modal-finalize-progress-hint"></div>
        </div>
        <div class="vp-modal-item">
          <div class="vp-modal-label">Motorista</div>
          <div class="vp-modal-sub" id="ride-modal-driver-name">Aguardando motorista aceitar</div>
          <div class="vp-modal-sub vp-modal-inline">
            <span id="ride-modal-driver-phone">—</span>
            <a class="btn btn-success btn-sm vp-modal-whatsapp d-none" id="ride-modal-whatsapp" href="#" target="_blank" rel="noopener noreferrer">WhatsApp</a>
          </div>
        </div>
        <div class="vp-modal-item">
          <div class="vp-modal-label">Rota</div>
          <div class="vp-modal-sub" id="ride-modal-origem">Origem: —</div>
          <div class="vp-modal-sub" id="ride-modal-destino">Destino: —</div>
          <div class="vp-modal-sub" id="ride-modal-seats">Lugares: —</div>
        </div>
      </div>
      <div class="mt-3 d-flex justify-content-end gap-2 flex-wrap">
        <button class="btn btn-outline-danger btn-sm" id="modal-cancel-ride">Cancelar</button>
        <button class="btn btn-success btn-sm d-none" id="modal-finalize-ride">Finalizar</button>
      </div>
    </div>
  </div>
  <!-- Modal de corrida aberta (motorista) -->
  <div class="vp-modal-backdrop" id="driver-ride-modal">
    <div class="vp-modal">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="vp-title mb-0">Corrida atribuída</h5>
        <span class="vp-badge">Eco-taxista</span>
      </div>
      <div class="vp-muted mb-2">Você recebeu uma corrida. Aceite e acompanhe o trajeto.</div>
      <div id="driver-ride-modal-map"></div>
      <div class="vp-modal-grid" id="driver-ride-modal-body">
        <div class="vp-modal-item vp-modal-status">
          <div class="vp-modal-label">Status</div>
          <div class="vp-modal-value" id="driver-modal-status">Aguardando sua confirmação</div>
          <div class="vp-modal-sub" id="driver-modal-status-hint">Corrida aguardando sua confirmação.</div>
        </div>
        <div class="vp-modal-item">
          <div class="vp-modal-label">Passageiro</div>
          <div class="vp-modal-sub" id="driver-modal-passenger-name">—</div>
          <div class="vp-modal-sub vp-modal-inline">
            <span id="driver-modal-passenger-phone">—</span>
            <a class="btn btn-success btn-sm vp-modal-whatsapp d-none" id="driver-modal-whatsapp" href="#" target="_blank" rel="noopener noreferrer">WhatsApp</a>
          </div>
        </div>
        <div class="vp-modal-item">
          <div class="vp-modal-label">Rota</div>
          <div class="vp-modal-sub" id="driver-modal-origem">Origem: —</div>
          <div class="vp-modal-sub" id="driver-modal-destino">Destino: —</div>
          <div class="vp-modal-sub" id="driver-modal-seats">Lugares: —</div>
        </div>
      </div>
      <div class="d-flex flex-wrap gap-2 mt-3 justify-content-end">
        <button class="btn btn-outline-success btn-sm" id="btn-aceitar">Aceitar</button>
        <button class="btn btn-outline-danger btn-sm" id="btn-rejeitar">Rejeitar</button>
        <button class="btn btn-outline-success btn-sm" id="btn-iniciar">Iniciar</button>
        <button class="btn btn-outline-success btn-sm" id="btn-finalizar">Finalizar</button>
      </div>
    </div>
  </div>
  <div class="vp-modal-backdrop" id="delete-account-modal">
    <div class="vp-modal">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="vp-title mb-0">Excluir conta</h5>
        <span class="vp-badge">Privacidade</span>
      </div>
      <p class="vp-muted mb-2">Ao confirmar, todos os seus dados serão removidos definitivamente.</p>
      <div class="mb-2">
        <label class="vp-modal-label" for="delete-password">Senha</label>
        <input class="form-control" type="password" id="delete-password" autocomplete="current-password" placeholder="Digite sua senha">
      </div>
      <div class="mb-2">
        <label class="vp-modal-label" for="delete-password-confirm">Confirmar senha</label>
        <input class="form-control" type="password" id="delete-password-confirm" autocomplete="current-password" placeholder="Digite novamente">
      </div>
      <div class="vp-muted text-danger" id="delete-account-error"></div>
      <div class="d-flex flex-wrap gap-2 mt-3 justify-content-end">
        <button class="btn btn-outline-secondary btn-sm" id="btn-cancel-delete">Cancelar</button>
        <button class="btn btn-danger btn-sm" id="btn-confirm-delete">Excluir conta</button>
      </div>
    </div>
  </div>
  <div class="vp-modal-backdrop" id="payment-warning-modal">
    <div class="vp-modal">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="vp-title mb-0">Aviso sobre pagamento</h5>
        <span class="vp-badge">Importante</span>
      </div>
      <p class="vp-muted mb-2">
        O pagamento deve ser combinado diretamente entre passageiro e eco-taxista. O app apenas conecta vocês.
      </p>
      <div class="d-flex flex-wrap gap-2 mt-3 justify-content-end">
        <button class="btn btn-success btn-sm" id="btn-payment-warning-ok">Entendi</button>
      </div>
    </div>
  </div>
  <div class="vp-modal-backdrop" id="terms-modal">
    <div class="vp-modal">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="vp-title mb-0">Termos de Uso</h5>
        <span class="vp-badge">Atualizado</span>
      </div>
      <div class="vp-muted">
        <p><strong>1. O que o app faz</strong><br>O Vai Paqueta conecta passageiros e eco-taxistas na Ilha de Paqueta. O app nao realiza o transporte e nao e responsavel pela execucao da corrida.</p>
        <p><strong>2. Pagamento e negociacao</strong><br>O valor, a forma de pagamento e qualquer negociacao da corrida sao de responsabilidade do passageiro e do eco-taxista. O app apenas conecta as partes e nao cobra taxa.</p>
        <p><strong>3. Limite de lugares</strong><br>Atualmente o app aceita solicitacoes de ate 2 lugares por corrida. No futuro, pode ser possivel solicitar mais lugares; nesse caso, o app pode distribuir a solicitacao entre diferentes eco-taxistas.</p>
        <p><strong>4. Idade minima</strong><br>Somente maiores de 18 anos podem usar o app.</p>
        <p><strong>5. Uso responsavel</strong><br>Voce se compromete a fornecer informacoes corretas e respeitar as regras locais e os demais usuarios.</p>
        <p><strong>6. Privacidade e dados</strong><br>Usamos dados para operar o servico, como localizacao e informacoes de cadastro. Os dados sao armazenados com seguranca e podem ser excluidos com a exclusao da conta.</p>
        <p><strong>7. Alteracoes</strong><br>O termo pode ser atualizado. Mudancas relevantes podem exigir nova confirmacao.</p>
      </div>
      <div class="d-flex flex-wrap gap-2 mt-3 justify-content-end">
        <button class="btn btn-success btn-sm" id="btn-terms-ok">Entendi</button>
      </div>
    </div>
  </div>
  <div class="vp-modal-backdrop" id="error-modal">
    <div class="vp-modal vp-modal-error">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="vp-title mb-0">Ops, algo deu errado</h5>
        <span class="vp-badge vp-badge-error">Erro</span>
      </div>
      <p class="vp-muted mb-2" id="error-modal-message">Não foi possível completar a ação.</p>
      <div class="d-flex flex-wrap gap-2 mt-3 justify-content-end">
        <button class="btn btn-danger btn-sm" id="btn-error-modal-ok">Fechar</button>
      </div>
    </div>
  </div>
  <script>
    const state = {
      user: null,
      map: null,
      markers: {},
      rideModalMap: null,
      rideModalMarkers: {},
      driverModalMap: null,
      driverModalMarkers: {},
      watchId: null,
      addresses: [],
      addressIndex: new Map(),
      ridePolling: null,
      driverRidePolling: null,
      activePassengerRide: null,
      activeDriverRide: null,
      lastDriverLocation: null,
      cancelUnlockTimer: null,
      finalizeUnlockTimer: null,
      serverOffsetMs: 0,
      routeLayers: {
        main: { ride: null, driver: null },
        rideModal: { ride: null, driver: null },
        driverModal: { ride: null, driver: null },
      },
      routeKeys: {
        main: { ride: null, driver: null },
        rideModal: { ride: null, driver: null },
        driverModal: { ride: null, driver: null },
      },
      routeRequests: {
        main: { ride: 0, driver: 0 },
        rideModal: { ride: 0, driver: 0 },
        driverModal: { ride: 0, driver: 0 },
      },
    };
    let refreshPromise = null;
    const ADDRESSES_URL = "{% static 'landing/data/addresses.json' %}";
    const DEFAULT_DDI = '55';
    const FALLBACK_COUNTRY_OPTIONS = [
      { code: '55', name: 'Brasil', iso2: 'BR' },
    ];
    let COUNTRY_OPTIONS = [];
    let countryOptionsPromise = null;

    function isoToFlag(iso2) {
      if (!iso2 || iso2.length !== 2) return '';
      const base = 127397;
      const chars = iso2.toUpperCase().split('').map((c) => base + c.charCodeAt(0));
      return String.fromCodePoint(...chars);
    }

    function normalizeCountryOptions(list) {
      return (Array.isArray(list) ? list : [])
        .map((item) => {
          const code = String(item.ddi || item.code || '').trim();
          if (!code) return null;
          const iso2 = String(item.iso2 || item.country || '').trim().toUpperCase();
          const name = String(item.name || item.nome || iso2 || `+${code}`).trim();
          return {
            code,
            name,
            iso2,
            flag: isoToFlag(iso2),
          };
        })
        .filter(Boolean)
        .sort((a, b) => a.name.localeCompare(b.name));
    }

    function getCountryOptions() {
      return COUNTRY_OPTIONS.length ? COUNTRY_OPTIONS : FALLBACK_COUNTRY_OPTIONS;
    }

    async function loadCountryOptions() {
      if (!countryOptionsPromise) {
        countryOptionsPromise = fetch('/api/geo/countries/')
          .then(async (res) => {
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.detail || res.statusText);
            const list = Array.isArray(data) ? data : data.countries || [];
            const normalized = normalizeCountryOptions(list);
            if (normalized.length) {
              COUNTRY_OPTIONS = normalized;
            }
          })
          .catch((err) => {
            console.warn('Falha ao carregar lista de países', err);
          })
          .finally(() => {
            initPhoneSelects();
            if (state.user) setPhoneFields('perfil', state.user.telefone || '');
          });
      }
      return countryOptionsPromise;
    }

    function buildDdiSelect(selectEl, initialValue) {
      if (!selectEl) return;
      selectEl.innerHTML = '';
      getCountryOptions().forEach((country) => {
        const option = document.createElement('option');
        option.value = country.code;
        const flag = country.flag || isoToFlag(country.iso2);
        option.textContent = `${flag ? `${flag} ` : ''}+${country.code}`;
        selectEl.appendChild(option);
      });
      selectEl.value = initialValue || DEFAULT_DDI;
    }

    function initPhoneSelects() {
      buildDdiSelect(document.getElementById('reg-ddi'), DEFAULT_DDI);
      buildDdiSelect(document.getElementById('perfil-ddi'), DEFAULT_DDI);
    }

    function parsePhoneParts(rawPhone) {
      const raw = (rawPhone || '').toString().trim();
      const digits = raw.replace(/\D+/g, '');
      if (!digits) {
        return { ddi: DEFAULT_DDI, ddd: '', numero: '' };
      }
      if (!raw.startsWith('+') && digits.length >= 8 && digits.length <= 11) {
        return { ddi: DEFAULT_DDI, ddd: digits.slice(0, 2), numero: digits.slice(2) };
      }
      const ddiCodes = getCountryOptions()
        .map((c) => c.code)
        .sort((a, b) => b.length - a.length);
      let ddi = '';
      for (const code of ddiCodes) {
        if (digits.startsWith(code)) {
          ddi = code;
          break;
        }
      }
      let rest = digits;
      if (ddi) {
        rest = digits.slice(ddi.length);
      } else {
        ddi = DEFAULT_DDI;
      }
      let ddd = '';
      let numero = rest;
      if (rest.length >= 4) {
        if (ddi === '1') {
          ddd = rest.slice(0, 3);
          numero = rest.slice(3);
        } else if (ddi === '55') {
          ddd = rest.slice(0, 2);
          numero = rest.slice(2);
        } else {
          ddd = rest.slice(0, 2);
          numero = rest.slice(2);
        }
      }
      return { ddi, ddd, numero };
    }

    function formatDddNumero(ddd, numero) {
      if (!ddd && !numero) return '';
      if (!numero) return ddd;
      if (!ddd) return numero;
      return `${ddd} ${numero}`;
    }

    function splitDddNumero(ddi, raw) {
      const match = String(raw || '').match(/(\d{1,5})\D+(\d{4,})/);
      if (match) {
        return { ddd: match[1], numero: match[2] };
      }
      const digits = String(raw || '').replace(/\D+/g, '');
      if (!digits) return { ddd: '', numero: '' };
      if (ddi === '55' && digits.length >= 3) {
        return { ddd: digits.slice(0, 2), numero: digits.slice(2) };
      }
      if (ddi === '1' && digits.length >= 4) {
        return { ddd: digits.slice(0, 3), numero: digits.slice(3) };
      }
      if (digits.length >= 3) {
        return { ddd: digits.slice(0, 2), numero: digits.slice(2) };
      }
      return { ddd: '', numero: '' };
    }

    function setPhoneFields(prefix, rawPhone) {
      const parts = parsePhoneParts(rawPhone);
      const ddiEl = document.getElementById(`${prefix}-ddi`);
      if (ddiEl && !ddiEl.options.length) {
        buildDdiSelect(ddiEl, parts.ddi);
      } else if (ddiEl) {
        ddiEl.value = parts.ddi;
      }
      const phoneEl = document.getElementById(`${prefix}-telefone`);
      if (phoneEl) phoneEl.value = formatDddNumero(parts.ddd, parts.numero);
    }

    function getPhoneFields(prefix) {
      const ddi = (document.getElementById(`${prefix}-ddi`)?.value || '').trim();
      const telefone = (document.getElementById(`${prefix}-telefone`)?.value || '').trim();
      const parts = splitDddNumero(ddi, telefone);
      return { ddi, ddd: parts.ddd || '', numero: parts.numero || '' };
    }

    function loadSession() {
      loadCountryOptions();
      try {
        const u = localStorage.getItem('vp_user');
        state.user = u ? JSON.parse(u) : null;
      } catch (e) {
        console.warn('Erro ao carregar sessão', e);
      }
      renderSession();
      toggleAuthViews();
      if (state.user) initMap();
      syncSession();
    }

    function saveSession() {
      localStorage.setItem('vp_user', state.user ? JSON.stringify(state.user) : '');
      localStorage.removeItem('vp_access');
      localStorage.removeItem('vp_refresh');
      renderSession();
      toggleAuthViews();
      enforceRoleTabs();
      ensurePassengerPolling();
      ensureDriverPolling();
    }

    async function revokeRefreshToken() {
      try {
        await fetch('/api/auth/logout/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Use-Cookies': '1' },
          credentials: 'include',
        });
      } catch (e) {
        console.warn('Falha ao revogar refresh token', e);
      }
    }

    async function logout() {
      await revokeRefreshToken();
      state.user = null;
      state.lastDriverLocation = null;
      saveSession();
      const passengerStatus = document.getElementById('passageiro-corrida');
      if (passengerStatus) passengerStatus.textContent = '{}';
      clearDriverModalDetails();
      state.activePassengerRide = null;
      state.activeDriverRide = null;
      renderRideModal(null);
      renderDriverModal(null);
    }

    function renderSession() {
      const label = document.getElementById('session-user');
      label.textContent = state.user ? `${state.user.nome || ''} • ${state.user.email}` : 'Não autenticado';
      const badge = document.getElementById('session-profile-badge');
      if (badge) {
        if (state.user?.perfil_tipo) {
          const perfilLabel =
            state.user.perfil_tipo === 'passageiro'
              ? 'Passageiro'
              : state.user.perfil_tipo === 'ecotaxista'
                ? 'Eco-taxista'
                : state.user.perfil_tipo;
          badge.textContent = perfilLabel;
          badge.classList.remove('d-none');
        } else {
          badge.textContent = '';
          badge.classList.add('d-none');
        }
      }
      if (state.user) {
        document.getElementById('perfil-tipo').value = state.user.perfil_tipo || 'passageiro';
        document.getElementById('perfil-nome').value = state.user.nome || '';
        setPhoneFields('perfil', state.user.telefone || '');
      }
      const logoutBtn = document.getElementById('btn-logout');
      if (logoutBtn) {
        logoutBtn.classList.toggle('d-none', !state.user);
      }
      const deleteBtn = document.getElementById('btn-delete-account');
      if (deleteBtn) {
        deleteBtn.classList.toggle('d-none', !state.user);
      }
    }

    function toggleAuthViews() {
      const auth = document.getElementById('auth-section');
      const app = document.getElementById('app-section');
      if (state.user) {
        auth.classList.add('d-none');
        app.classList.remove('d-none');
        setTimeout(() => { if (state.map) state.map.invalidateSize(); }, 200);
      } else {
        auth.classList.remove('d-none');
        app.classList.add('d-none');
        stopAutoPing();
      }
    }

    async function syncSession() {
      try {
        const data = await api('/api/auth/me/', { method: 'GET', headers: { 'X-Use-Cookies': '1' } });
        if (data.user) {
          state.user = data.user;
          saveSession();
          if (!state.map) initMap();
          ensureAutoPing();
          enforceRoleTabs();
        }
      } catch (e) {
        if (state.user) logout();
      }
    }

    function getCookie(name) {
      const cookie = document.cookie || '';
      const parts = cookie.split(';').map((c) => c.trim());
      for (const part of parts) {
        if (part.startsWith(`${name}=`)) {
          return decodeURIComponent(part.substring(name.length + 1));
        }
      }
      return '';
    }

    // Toggle login/cadastro
    document.querySelectorAll('#auth-toggle button').forEach((btn) => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#auth-toggle button').forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        const mode = btn.dataset.auth;
        document.getElementById('auth-login-form').classList.toggle('d-none', mode !== 'login');
        document.getElementById('auth-register-form').classList.toggle('d-none', mode !== 'register');
        const termsEl = document.getElementById('reg-terms');
        if (termsEl) termsEl.checked = false;
      });
    });

    async function refreshAccessToken() {
      if (!refreshPromise) {
        const csrfToken = getCookie('csrftoken');
        const headers = { 'Content-Type': 'application/json', 'X-Use-Cookies': '1' };
        if (csrfToken) headers['X-CSRFToken'] = csrfToken;
        refreshPromise = fetch('/api/auth/token/refresh/', {
          method: 'POST',
          headers,
          credentials: 'include',
        })
          .then(async (res) => {
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
              const err = new Error(data.detail || res.statusText);
              err.status = res.status;
              throw err;
            }
            return true;
          })
          .finally(() => {
            refreshPromise = null;
          });
      }
      return refreshPromise;
    }

    async function api(path, { method = 'GET', body, retry = false, headers = {} } = {}) {
      const mergedHeaders = { 'Content-Type': 'application/json', ...headers };
      const csrfToken = getCookie('csrftoken');
      if (csrfToken && !mergedHeaders['X-CSRFToken']) {
        mergedHeaders['X-CSRFToken'] = csrfToken;
      }
      const res = await fetch(path, {
        method,
        headers: mergedHeaders,
        credentials: 'include',
        body: body ? JSON.stringify(body) : undefined,
      });
      if (res.status === 401 && !retry) {
        try {
          await refreshAccessToken();
          return api(path, { method, body, retry: true, headers });
        } catch (e) {
          logout();
          throw e;
        }
      }
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        const err = new Error(data.detail || res.statusText);
        err.status = res.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    function setLoading(btn, loading) {
      if (!btn) return;
      btn.disabled = loading;
      btn.dataset.original = btn.dataset.original || btn.innerHTML;
      btn.innerHTML = loading ? '<span class="spinner-border spinner-border-sm"></span>' : btn.dataset.original;
    }

    let errorModalOpen = false;
    let errorModalLastMessage = '';
    let errorModalLastAt = 0;
    const ERROR_MODAL_COOLDOWN_MS = 4000;

    function showErrorModal(message) {
      const modal = document.getElementById('error-modal');
      const messageEl = document.getElementById('error-modal-message');
      if (!modal || !messageEl) return;
      const msg = (message || '').trim() || 'Não foi possível completar a ação.';
      const now = Date.now();
      if (errorModalOpen && msg === errorModalLastMessage) return;
      if (!errorModalOpen && msg === errorModalLastMessage && now - errorModalLastAt < ERROR_MODAL_COOLDOWN_MS) return;
      messageEl.textContent = msg;
      modal.style.display = 'flex';
      errorModalOpen = true;
      errorModalLastMessage = msg;
      errorModalLastAt = now;
    }

    function hideErrorModal() {
      const modal = document.getElementById('error-modal');
      if (!modal) return;
      modal.style.display = 'none';
      errorModalOpen = false;
    }

    function toast(_msg, _isError = false) {
      if (_isError) {
        showErrorModal(_msg);
      }
    }

    // Tabs
    document.querySelectorAll('#vp-tabs .nav-link').forEach((btn) => {
      btn.addEventListener('click', () => switchTab(btn.dataset.target));
    });

    function switchTab(targetSelector) {
      document.querySelectorAll('#vp-tabs .nav-link').forEach((b) => b.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach((tab) => tab.classList.remove('show', 'active'));
      const btn = [...document.querySelectorAll('#vp-tabs .nav-link')].find((b) => b.dataset.target === targetSelector);
      if (btn) btn.classList.add('active');
      const target = document.querySelector(targetSelector);
      if (target) target.classList.add('show', 'active');
    }

    function enforceRoleTabs() {
      const passengerTabBtn = document.querySelector('[data-target="#tab-passenger"]');
      const driverTabBtn = document.querySelector('[data-target="#tab-driver"]');
      const passengerTab = document.querySelector('#tab-passenger');
      const driverTab = document.querySelector('#tab-driver');
      const profileTabBtn = document.querySelector('[data-target="#tab-profile"]');
      const profileTab = document.querySelector('#tab-profile');

      // Reset visibility
      [passengerTabBtn, driverTabBtn].forEach((btn) => btn.classList.add('d-none'));
      [passengerTab, driverTab].forEach((tab) => tab.classList.add('d-none'));
      profileTabBtn.classList.remove('d-none');
      profileTab.classList.remove('d-none');

      if (!state.user) {
        switchTab('#tab-profile');
        return;
      }
      const tipo = state.user.perfil_tipo;
      if (tipo === 'passageiro') {
        passengerTabBtn.classList.remove('d-none');
        passengerTab.classList.remove('d-none');
        switchTab('#tab-passenger');
      } else if (tipo === 'ecotaxista') {
        driverTabBtn.classList.remove('d-none');
        driverTab.classList.remove('d-none');
        switchTab('#tab-driver');
      } else {
        switchTab('#tab-profile');
      }
    }

    // Auth
    document.getElementById('btn-login').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const btn = document.getElementById('btn-login');
      try {
        setLoading(btn, true);
        const data = await api('/api/auth/login/', {
          method: 'POST',
          body: { email, password },
          headers: { 'X-Use-Cookies': '1' },
        });
        state.user = data.user || null;
        if (!state.user) {
          throw new Error('Resposta inválida do servidor.');
        }
        saveSession();
        initMap();
        ensureAutoPing();
        enforceRoleTabs();
        toast('Login feito!');
      } catch (e) {
        toast(e.message, true);
      } finally {
        setLoading(btn, false);
      }
    });

    document.getElementById('btn-register').addEventListener('click', async () => {
      const phone = getPhoneFields('reg');
      const password = document.getElementById('reg-password').value;
      const passwordConfirm = document.getElementById('reg-password-confirm').value;
      const termsAccepted = document.getElementById('reg-terms')?.checked;
      const body = {
        nome: document.getElementById('reg-nome').value.trim(),
        ddi: phone.ddi,
        ddd: phone.ddd,
        numero: phone.numero,
        email: document.getElementById('reg-email').value.trim(),
        password,
        password_confirm: passwordConfirm,
        tipo: 'passageiro',
      };
      const btn = document.getElementById('btn-register');
      try {
        setLoading(btn, true);
        if (!body.ddi || !body.ddd || !body.numero) {
          throw new Error('Informe DDI, DDD e número do telefone.');
        }
        if (!password || !passwordConfirm) {
          throw new Error('Informe e confirme a senha.');
        }
        if (password !== passwordConfirm) {
          throw new Error('As senhas não conferem.');
        }
        if (!termsAccepted) {
          throw new Error('Aceite os Termos de Uso para continuar.');
        }
        const data = await api('/api/auth/register/', {
          method: 'POST',
          body,
          headers: { 'X-Use-Cookies': '1' },
        });
        state.user = data.user || null;
        if (!state.user) {
          throw new Error('Resposta inválida do servidor.');
        }
        saveSession();
        initMap();
        ensureAutoPing();
        enforceRoleTabs();
        toast('Cadastro criado e sessão iniciada!');
      } catch (e) {
        toast(e.message, true);
      } finally {
        setLoading(btn, false);
      }
    });

    document.getElementById('btn-logout').addEventListener('click', logout);

    document.getElementById('btn-update-profile').addEventListener('click', async () => {
      if (!state.user) return toast('Faça login primeiro', true);
      const deviceField = document.getElementById('perfil-device');
      const phone = getPhoneFields('perfil');
      const body = {
        nome: document.getElementById('perfil-nome').value.trim(),
        ddi: phone.ddi,
        ddd: phone.ddd,
        numero: phone.numero,
        tipo: document.getElementById('perfil-tipo').value,
      };
      if (deviceField && deviceField.value.trim()) {
        body.device_uuid = deviceField.value.trim();
      }
      const btn = document.getElementById('btn-update-profile');
      try {
        setLoading(btn, true);
        if (!body.ddi || !body.ddd || !body.numero) {
          throw new Error('Informe DDI, DDD e número do telefone.');
        }
        const data = await api('/api/auth/me/', { method: 'PATCH', body });
        state.user = data.user;
        saveSession();
        ensureAutoPing();
        enforceRoleTabs();
        // Sem toast de sucesso para evitar janelas extras.
      } catch (e) {
        toast(e.message, true);
      } finally {
        setLoading(btn, false);
      }
    });

    function toggleDeleteModal(show) {
      const modal = document.getElementById('delete-account-modal');
      const errorEl = document.getElementById('delete-account-error');
      const passwordInput = document.getElementById('delete-password');
      const confirmInput = document.getElementById('delete-password-confirm');
      if (!modal) return;
      if (errorEl) errorEl.textContent = '';
      if (passwordInput) passwordInput.value = '';
      if (confirmInput) confirmInput.value = '';
      modal.style.display = show ? 'flex' : 'none';
    }

    function togglePaymentWarningModal(show) {
      const modal = document.getElementById('payment-warning-modal');
      if (!modal) return;
      modal.style.display = show ? 'flex' : 'none';
    }

    function toggleTermsModal(show) {
      const modal = document.getElementById('terms-modal');
      if (!modal) return;
      modal.style.display = show ? 'flex' : 'none';
    }

    function bindErrorModal() {
      const modal = document.getElementById('error-modal');
      const btn = document.getElementById('btn-error-modal-ok');
      if (btn) {
        btn.addEventListener('click', () => hideErrorModal());
      }
      if (modal) {
        modal.addEventListener('click', (event) => {
          if (event.target === modal) hideErrorModal();
        });
      }
    }

    document.getElementById('btn-delete-account').addEventListener('click', () => {
      if (!state.user) return;
      toggleDeleteModal(true);
    });

    document.getElementById('btn-cancel-delete').addEventListener('click', () => {
      toggleDeleteModal(false);
    });

    document.getElementById('btn-confirm-delete').addEventListener('click', async () => {
      const btn = document.getElementById('btn-confirm-delete');
      const errorEl = document.getElementById('delete-account-error');
      const passwordInput = document.getElementById('delete-password');
      const confirmInput = document.getElementById('delete-password-confirm');
      try {
        setLoading(btn, true);
        const password = passwordInput ? passwordInput.value : '';
        const passwordConfirm = confirmInput ? confirmInput.value : '';
        if (!password || !passwordConfirm) {
          throw new Error('Informe e confirme a senha.');
        }
        if (password !== passwordConfirm) {
          throw new Error('As senhas não conferem.');
        }
        await api('/api/auth/me/', {
          method: 'DELETE',
          body: { password, password_confirm: passwordConfirm },
        });
        toggleDeleteModal(false);
        logout();
      } catch (e) {
        if (errorEl) {
          errorEl.textContent = e.message || 'Não foi possível excluir a conta.';
        }
      } finally {
        setLoading(btn, false);
      }
    });

    document.getElementById('btn-payment-warning-ok').addEventListener('click', () => {
      togglePaymentWarningModal(false);
    });

    const termsLink = document.getElementById('open-terms-link');
    if (termsLink) {
      termsLink.addEventListener('click', (event) => {
        event.preventDefault();
        toggleTermsModal(true);
      });
    }
    const termsOk = document.getElementById('btn-terms-ok');
    if (termsOk) {
      termsOk.addEventListener('click', () => toggleTermsModal(false));
    }
    const termsModal = document.getElementById('terms-modal');
    if (termsModal) {
      termsModal.addEventListener('click', (event) => {
        if (event.target === termsModal) toggleTermsModal(false);
      });
    }

    bindErrorModal();

    // GPS helper
    async function requestOriginGps(opts = {}) {
      const silent = Boolean(opts && opts.silent);
      if (!navigator.geolocation) {
        if (!silent) toast('Geolocalização não suportada. Escolha um endereço de origem.', true);
        return;
      }
      if (!window.isSecureContext && location.hostname !== 'localhost') {
        if (!silent) {
          toast('GPS no navegador exige https ou localhost. Abra em http://localhost:8000 ou habilite https.', true);
        }
        return;
      }
      const getPos = (opts) =>
        new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, opts);
        });
      if (!silent) toast('Solicitando sua localização...', false);
      const attempts = [
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 },
        { enableHighAccuracy: false, timeout: 30000, maximumAge: 0 },
      ];
      try {
        let pos = null;
        for (const opts of attempts) {
          try {
            // eslint-disable-next-line no-await-in-loop
            pos = await getPos(opts);
            break;
          } catch (err) {
            if (err && err.code === 3) continue; // timeout, tenta próxima
            throw err;
          }
        }
        if (!pos) throw new Error('timeout');
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        document.getElementById('origem-lat').value = lat;
        document.getElementById('origem-lng').value = lng;
        const addr = await reverseGeocode(lat, lng);
        document.getElementById('origem-end').value = addr || 'Sua localização atual';
        // Limpa os campos de destino lat/lng para evitar reuso incorreto
        document.getElementById('destino-lat').value = document.getElementById('destino-lat').value || '';
        document.getElementById('destino-lng').value = document.getElementById('destino-lng').value || '';
        if (!silent && !opts?.suppressSuccess) toast('Origem preenchida com seu GPS');
        updateMapFromRide({
          origem_lat: lat,
          origem_lng: lng,
        });
      } catch (err) {
        console.warn('GPS origem falhou', err);
        let msg = 'Não foi possível ler sua localização. Informe o endereço manualmente.';
        if (err && err.code === 1) msg = 'Permita o GPS no navegador (https ou localhost) ou escolha um endereço manualmente.';
        if (err && err.code === 2) msg = 'Sinal de GPS indisponível agora. Tente novamente ou escolha um endereço.';
        if (err && err.code === 3) msg = 'Tempo esgotado para pegar o GPS. Escolha um endereço ou tente novamente.';
        if (!silent) toast(msg, true);
      }
    }
    document.getElementById('btn-origem-gps').addEventListener('click', () => {
      requestOriginGps({ suppressSuccess: true });
    });
    const pingGpsBtn = document.getElementById('btn-ping-gps');
    if (pingGpsBtn) {
      pingGpsBtn.addEventListener('click', async () => {
        if (!navigator.geolocation) {
          toast('Geolocalização não suportada.', true);
          return;
        }
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const lat = pos.coords.latitude.toFixed(6);
            const lng = pos.coords.longitude.toFixed(6);
            document.getElementById('driver-lat').value = lat;
            document.getElementById('driver-lng').value = lng;
            try {
              const addr = await reverseGeocode(lat, lng);
              document.getElementById('driver-end').value = addr || 'Sua localização atual';
            } catch (e) {
              document.getElementById('driver-end').value = 'Sua localização atual';
            }
            updateDriverLocation(Number(lat), Number(lng));
          },
          (err) => toast(err.message, true),
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });
    }

    // Address suggestions
    async function loadAddresses() {
      try {
        const res = await fetch(ADDRESSES_URL);
        const data = await res.json();
        state.addresses = data || [];
        state.addressIndex.clear();
        state.addresses.forEach((addr) => {
          const label = `${addr.street}${addr.housenumber ? ' ' + addr.housenumber : ''}`;
          state.addressIndex.set(label.toLowerCase(), { lat: addr.lat, lng: addr.lng, label });
        });
      } catch (e) {
        console.warn('Falha ao carregar addresses.json', e);
      }
    }

    function applyAddress(inputId, latId, lngId) {
      const val = document.getElementById(inputId).value.trim().toLowerCase();
      const match = state.addressIndex.get(val);
      if (match) {
        document.getElementById(latId).value = match.lat;
        document.getElementById(lngId).value = match.lng;
        return;
      }
      // Não limpe se veio do GPS ou já existe coord válida
      if (val === 'sua localização atual') return;
      const currentLat = document.getElementById(latId).value;
      const currentLng = document.getElementById(lngId).value;
      if (currentLat && currentLng) return;
      if (!val) {
        document.getElementById(latId).value = '';
        document.getElementById(lngId).value = '';
      }
    }

    function updateDatalistSuggestions(term) {
      const list = document.getElementById('addresses-list');
      list.innerHTML = '';
      const query = term.trim().toLowerCase();
      if (!query || query.length < 2) return; // só mostra sugestões a partir de 2 caracteres
      let count = 0;
      for (const [key, val] of state.addressIndex.entries()) {
        if (key.includes(query)) {
          const opt = document.createElement('option');
          opt.value = val.label;
          list.appendChild(opt);
          count += 1;
          if (count >= 15) break; // limita sugestões
        }
      }
    }

    ['change', 'input', 'blur', 'focus'].forEach((evt) => {
      document.getElementById('origem-end').addEventListener(evt, () => {
        updateDatalistSuggestions(document.getElementById('origem-end').value);
        applyAddress('origem-end', 'origem-lat', 'origem-lng');
        renderInputMarkers();
      });
      document.getElementById('destino-end').addEventListener(evt, () => {
        updateDatalistSuggestions(document.getElementById('destino-end').value);
        applyAddress('destino-end', 'destino-lat', 'destino-lng');
        renderInputMarkers();
      });
      const driverEnd = document.getElementById('driver-end');
      if (driverEnd) {
        driverEnd.addEventListener(evt, () => {
          updateDatalistSuggestions(driverEnd.value);
          applyAddress('driver-end', 'driver-lat', 'driver-lng');
        });
      }
    });

    function parseCoord(val) {
      const n = parseFloat(val);
      if (Number.isNaN(n)) return null;
      return n.toFixed(6);
    }

    async function reverseGeocode(lat, lng) {
      try {
        const res = await fetch(`/api/geo/reverse/?lat=${lat}&lng=${lng}`);
        if (!res.ok) return null;
        const data = await res.json();
        return data.endereco || null;
      } catch (e) {
        console.warn('Falha no reverse geocode', e);
        return null;
      }
    }

    // Passenger flow
    document.getElementById('btn-solicitar').addEventListener('click', async () => {
      if (!state.user?.perfil_id) return toast('Faça login para pedir corrida', true);
      applyAddress('origem-end', 'origem-lat', 'origem-lng');
      applyAddress('destino-end', 'destino-lat', 'destino-lng');
      const origemLat = parseCoord(document.getElementById('origem-lat').value);
      const origemLng = parseCoord(document.getElementById('origem-lng').value);
      const destinoLat = parseCoord(document.getElementById('destino-lat').value);
      const destinoLng = parseCoord(document.getElementById('destino-lng').value);
      const seats = parseInt(document.getElementById('passenger-seats').value, 10);
      if (![1, 2].includes(seats)) return toast('Selecione 1 ou 2 lugares.', true);
      const body = {
        perfil_id: state.user.perfil_id,
        origem_lat: origemLat,
        origem_lng: origemLng,
        destino_lat: destinoLat,
        destino_lng: destinoLng,
        origem_endereco: document.getElementById('origem-end').value,
        destino_endereco: document.getElementById('destino-end').value,
        lugares: seats,
      };
      if (!body.origem_lat || !body.origem_lng) return toast('Pegue sua localização (botão GPS) ou escolha uma origem sugerida.', true);
      if (!body.destino_lat || !body.destino_lng) return toast('Escolha um destino das sugestões para continuarmos.', true);
      const btn = document.getElementById('btn-solicitar');
      try {
        setLoading(btn, true);
        const corrida = await api('/api/corridas/solicitar/', { method: 'POST', body });
        renderPassengerRide(corrida);
        togglePaymentWarningModal(true);
      } catch (e) {
        if (e.status === 409 && e.data?.corrida) {
          renderPassengerRide(e.data.corrida);
          togglePaymentWarningModal(true);
          toast(e.message);
        } else {
          toast(e.message, true);
        }
      } finally {
        setLoading(btn, false);
      }
    });

    async function fetchPassengerRide() {
      if (!state.user?.perfil_id) return;
      const corrida = await api(`/api/corridas/para_passageiro/${state.user.perfil_id}/`);
      renderPassengerRide(corrida);
    }
    const refreshPassengerBtn = document.getElementById('btn-refresh-passenger');
    if (refreshPassengerBtn) {
      refreshPassengerBtn.addEventListener('click', async () => {
        try { await fetchPassengerRide(); } catch (e) { toast(e.message, true); }
      });
    }

    const ACTIVE_RIDE_STATUSES = new Set(['aguardando', 'aceita', 'em_andamento']);

    function normalizeRideStatus(status) {
      const key = (status || '')
        .toString()
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '_');
      if (key === 'aguardando_motorista') return 'aguardando';
      return key;
    }

    function isActiveRideStatus(status) {
      return ACTIVE_RIDE_STATUSES.has(normalizeRideStatus(status));
    }

    const CANCEL_AFTER_ACCEPT_MS = 2 * 60 * 1000;
    const FINALIZE_AFTER_START_MS = 3 * 60 * 1000;

    function acceptedAtMs(corrida) {
      if (!corrida || !corrida.atualizado_em) return null;
      const ts = Date.parse(corrida.atualizado_em);
      return Number.isNaN(ts) ? null : ts;
    }

    function cancelUnlockRemainingMs(corrida) {
      if (!corrida || normalizeRideStatus(corrida.status) !== 'aceita') return 0;
      const acceptedAt = acceptedAtMs(corrida);
      if (!acceptedAt) return 0;
      const now = Date.now() + (state.serverOffsetMs || 0);
      const remaining = CANCEL_AFTER_ACCEPT_MS - (now - acceptedAt);
      return Math.max(0, remaining);
    }

    function startedAtMs(corrida) {
      if (!corrida || !corrida.atualizado_em) return null;
      const ts = Date.parse(corrida.atualizado_em);
      return Number.isNaN(ts) ? null : ts;
    }

    function finalizeUnlockRemainingMs(corrida) {
      if (!corrida || normalizeRideStatus(corrida.status) !== 'em_andamento') return 0;
      const startedAt = startedAtMs(corrida);
      if (!startedAt) return 0;
      const now = Date.now() + (state.serverOffsetMs || 0);
      const remaining = FINALIZE_AFTER_START_MS - (now - startedAt);
      return Math.max(0, remaining);
    }

    function formatRemainingMs(ms) {
      const totalSeconds = Math.max(0, Math.ceil(ms / 1000));
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes}:${String(seconds).padStart(2, '0')}`;
    }

    function formatSeats(value) {
      const seats = Number(value) || 1;
      return seats === 1 ? '1 lugar' : `${seats} lugares`;
    }

    function stopCancelUnlockTimer() {
      if (state.cancelUnlockTimer) {
        clearInterval(state.cancelUnlockTimer);
        state.cancelUnlockTimer = null;
      }
    }

    function stopFinalizeUnlockTimer() {
      if (state.finalizeUnlockTimer) {
        clearInterval(state.finalizeUnlockTimer);
        state.finalizeUnlockTimer = null;
      }
    }

    function updateCancelUnlockUi() {
      const cancelBtn = document.getElementById('modal-cancel-ride');
      const progressWrap = document.getElementById('ride-modal-cancel-progress');
      const progressBar = document.getElementById('ride-modal-cancel-progress-bar');
      const progressHint = document.getElementById('ride-modal-cancel-progress-hint');
      const finalizeWrap = document.getElementById('ride-modal-finalize-progress');
      const finalizeBar = document.getElementById('ride-modal-finalize-progress-bar');
      const finalizeHint = document.getElementById('ride-modal-finalize-progress-hint');
      const finalizeBtn = document.getElementById('modal-finalize-ride');
      if (!cancelBtn || !progressWrap || !progressBar || !progressHint) return;
      const corrida = state.activePassengerRide;
      if (!corrida || !corrida.id || !isActiveRideStatus(corrida.status)) {
        cancelBtn.classList.add('d-none');
        progressWrap.classList.add('d-none');
        progressHint.classList.add('d-none');
        progressBar.style.width = '0%';
        progressHint.textContent = '';
        stopCancelUnlockTimer();
        return;
      }
      const status = normalizeRideStatus(corrida.status);
      const remaining = cancelUnlockRemainingMs(corrida);
      const locked = status === 'aceita' && remaining > 0;
      cancelBtn.textContent = 'Cancelar';
      const canCancel = status === 'aguardando' || (status === 'aceita' && remaining <= 0);
      cancelBtn.classList.toggle('d-none', !canCancel);
      if (locked) {
        const progress = 1 - remaining / CANCEL_AFTER_ACCEPT_MS;
        progressBar.style.width = `${Math.min(100, Math.max(0, progress * 100))}%`;
        progressHint.textContent = `Cancelamento liberado em ${formatRemainingMs(remaining)}`;
        progressWrap.classList.remove('d-none');
        progressHint.classList.remove('d-none');
        if (!state.cancelUnlockTimer) {
          state.cancelUnlockTimer = setInterval(updateCancelUnlockUi, 1000);
        }
      } else {
        progressWrap.classList.add('d-none');
        progressHint.classList.add('d-none');
        progressBar.style.width = '0%';
        progressHint.textContent = '';
        stopCancelUnlockTimer();
      }
    }

    function updateFinalizeUnlockUi() {
      const finalizeBtn = document.getElementById('modal-finalize-ride');
      const progressWrap = document.getElementById('ride-modal-finalize-progress');
      const progressBar = document.getElementById('ride-modal-finalize-progress-bar');
      const progressHint = document.getElementById('ride-modal-finalize-progress-hint');
      if (!finalizeBtn || !progressWrap || !progressBar || !progressHint) return;
      const corrida = state.activePassengerRide;
      if (!corrida || !corrida.id || !isActiveRideStatus(corrida.status)) {
        finalizeBtn.classList.add('d-none');
        progressWrap.classList.add('d-none');
        progressHint.classList.add('d-none');
        progressBar.style.width = '0%';
        progressHint.textContent = '';
        stopFinalizeUnlockTimer();
        return;
      }
      const status = normalizeRideStatus(corrida.status);
      const remaining = finalizeUnlockRemainingMs(corrida);
      const locked = status === 'em_andamento' && remaining > 0;
      const canFinalize = status === 'em_andamento' && remaining <= 0;
      finalizeBtn.classList.toggle('d-none', !canFinalize);
      if (locked) {
        const progress = 1 - remaining / FINALIZE_AFTER_START_MS;
        progressBar.style.width = `${Math.min(100, Math.max(0, progress * 100))}%`;
        progressHint.textContent = `Finalizacao liberada em ${formatRemainingMs(remaining)}`;
        progressWrap.classList.remove('d-none');
        progressHint.classList.remove('d-none');
        if (!state.finalizeUnlockTimer) {
          state.finalizeUnlockTimer = setInterval(updateFinalizeUnlockUi, 1000);
        }
      } else {
        progressWrap.classList.add('d-none');
        progressHint.classList.add('d-none');
        progressBar.style.width = '0%';
        progressHint.textContent = '';
        stopFinalizeUnlockTimer();
      }
    }

    function renderPassengerRide(corrida) {
      const passengerStatus = document.getElementById('passageiro-corrida');
      if (passengerStatus) passengerStatus.textContent = JSON.stringify(corrida || {}, null, 2);
      if (corrida && corrida.server_time) {
        const serverTs = Date.parse(corrida.server_time);
        if (!Number.isNaN(serverTs)) {
          state.serverOffsetMs = serverTs - Date.now();
        }
      }
      if (corrida && corrida.id && isActiveRideStatus(corrida.status)) {
        state.activePassengerRide = corrida;
      } else {
        state.activePassengerRide = null;
      }
      if (state.activePassengerRide) {
        updateMapFromRide(state.activePassengerRide);
      } else {
        renderInputMarkers();
      }
      renderRideModal(state.activePassengerRide);
    }

    // Driver flow
    const sendPingBtn = document.getElementById('btn-enviar-ping');
    if (sendPingBtn) {
      sendPingBtn.addEventListener('click', async () => {
        if (!state.user?.perfil_id) return toast('Faça login', true);
        if (state.user.perfil_tipo !== 'ecotaxista') return toast('Troque o perfil para eco-taxista em Perfil', true);
        const btn = document.getElementById('btn-enviar-ping');
        applyAddress('driver-end', 'driver-lat', 'driver-lng');
        const lat = parseCoord(document.getElementById('driver-lat').value);
        const lng = parseCoord(document.getElementById('driver-lng').value);
        const precisao = document.getElementById('ping-precisao').value;
        if (!lat || !lng) return toast('Escolha um endereço válido ou use o GPS.', true);
        try {
          setLoading(btn, true);
          await sendPing(lat, lng, precisao ? parseFloat(precisao) : undefined);
        } catch (e) {
          toast(e.message, true);
        } finally {
          setLoading(btn, false);
        }
      });
    }

    async function fetchDriverRide() {
      if (!state.user?.perfil_id || state.user.perfil_tipo !== 'ecotaxista') return;
      const corrida = await api(`/api/corridas/para_motorista/${state.user.perfil_id}/`);
      renderDriverRide(corrida);
      return corrida;
    }
    const refreshDriverBtn = document.getElementById('btn-refresh-driver');
    if (refreshDriverBtn) {
      refreshDriverBtn.addEventListener('click', async () => {
        try { await fetchDriverRide(); } catch (e) { toast(e.message, true); }
      });
    }

    function renderDriverRide(corrida) {
      const hasActiveRide = corrida && corrida.id;
      state.activeDriverRide = hasActiveRide ? corrida : null;
      if (state.activeDriverRide) {
        updateMapFromRide(state.activeDriverRide);
      } else if (state.user?.perfil_tipo === 'ecotaxista' && state.lastDriverLocation) {
        updateMapFromRide({
          motorista_lat: state.lastDriverLocation.lat,
          motorista_lng: state.lastDriverLocation.lng,
        });
      } else {
        updateMapFromRide(null);
      }
      toggleDriverButtons(state.activeDriverRide);
      renderDriverModal(state.activeDriverRide);
    }

    function toggleDriverButtons(corrida) {
      const btnAceitar = document.getElementById('btn-aceitar');
      const btnRejeitar = document.getElementById('btn-rejeitar');
      const btnIniciar = document.getElementById('btn-iniciar');
      const btnFinalizar = document.getElementById('btn-finalizar');

      const show = (btn) => {
        if (!btn) return;
        btn.classList.remove('d-none');
        btn.removeAttribute('disabled');
      };
      [btnAceitar, btnRejeitar, btnIniciar, btnFinalizar].forEach((b) => {
        if (!b) return;
        b.setAttribute('disabled', 'disabled');
        b.classList.add('d-none');
      });
      if (!corrida || !corrida.status) return;
      const status = normalizeRideStatus(corrida.status);
      if (status === 'aguardando') {
        show(btnAceitar);
        show(btnRejeitar);
      }
      if (status === 'aceita') {
        show(btnRejeitar);
        show(btnIniciar);
      }
      if (status === 'em_andamento') {
        show(btnFinalizar);
      }
    }

    function renderInputMarkers() {
      // Mostra marcadores de origem/destino mesmo antes da corrida
      const origemLat = parseCoord(document.getElementById('origem-lat').value);
      const origemLng = parseCoord(document.getElementById('origem-lng').value);
      const destinoLat = parseCoord(document.getElementById('destino-lat').value);
      const destinoLng = parseCoord(document.getElementById('destino-lng').value);
      const fakeRide = {};
      if (origemLat && origemLng) {
        fakeRide.origem_lat = origemLat;
        fakeRide.origem_lng = origemLng;
      }
      if (destinoLat && destinoLng) {
        fakeRide.destino_lat = destinoLat;
        fakeRide.destino_lng = destinoLng;
      }
      updateMapFromRide(fakeRide);
    }

    const RIDE_STATUS_LABELS = {
      aguardando: 'Aguardando motorista',
      aceita: 'Motorista aceitou',
      em_andamento: 'Em andamento',
      cancelada: 'Cancelada',
      concluida: 'Concluída',
      rejeitada: 'Rejeitada',
    };

    function formatRideStatus(status) {
      const normalized = normalizeRideStatus(status);
      return RIDE_STATUS_LABELS[normalized] || status || 'Aguardando motorista';
    }

    function formatLatLng(lat, lng) {
      if (lat == null || lng == null) return null;
      const latNum = Number(lat);
      const lngNum = Number(lng);
      if (Number.isNaN(latNum) || Number.isNaN(lngNum)) return null;
      return `${latNum.toFixed(6)}, ${lngNum.toFixed(6)}`;
    }

    function updateDriverGpsStatus({ status, lastSent, coords } = {}) {
      const statusEl = document.getElementById('driver-gps-status');
      const lastEl = document.getElementById('driver-gps-last');
      const coordsEl = document.getElementById('driver-gps-coords');
      if (statusEl && status !== undefined) statusEl.textContent = status;
      if (lastEl && lastSent !== undefined) lastEl.textContent = lastSent ? `Último envio: ${lastSent}` : 'Último envio: —';
      if (coordsEl && coords !== undefined) coordsEl.textContent = coords ? `Posição: ${coords}` : 'Posição: —';
    }

    function updateDriverLocation(lat, lng) {
      if (lat == null || lng == null || Number.isNaN(lat) || Number.isNaN(lng)) return;
      state.lastDriverLocation = { lat, lng };
      if (state.user?.perfil_tipo !== 'ecotaxista') return;
      if (state.activeDriverRide) return;
      updateMapFromRide({ motorista_lat: lat, motorista_lng: lng });
    }

    let driverGpsSendingCount = 0;
    function setDriverGpsSending(active) {
      const wrap = document.getElementById('driver-gps-progress');
      const bar = document.getElementById('driver-gps-progress-bar');
      if (!wrap || !bar) return;
      if (active) {
        driverGpsSendingCount += 1;
        wrap.classList.add('is-active');
        bar.style.width = '100%';
        return;
      }
      driverGpsSendingCount = Math.max(0, driverGpsSendingCount - 1);
      if (driverGpsSendingCount === 0) {
        setTimeout(() => {
          if (driverGpsSendingCount === 0) {
            bar.style.width = '0%';
            wrap.classList.remove('is-active');
          }
        }, 300);
      }
    }

    function buildWhatsAppLink(phone) {
      const raw = (phone || '').toString().trim();
      const digits = raw.replace(/\D+/g, '');
      if (!digits) return null;
      let normalized = digits;
      if (!raw.startsWith('+') && digits.length <= 11 && !digits.startsWith('55')) {
        normalized = `55${digits}`;
      }
      if (normalized.length < 8 || normalized.length > 15) return null;
      return `https://wa.me/${normalized}`;
    }

    function updateRideModalDetails(corrida) {
      const statusEl = document.getElementById('ride-modal-status');
      const statusHintEl = document.getElementById('ride-modal-status-hint');
      const driverNameEl = document.getElementById('ride-modal-driver-name');
      const driverPhoneEl = document.getElementById('ride-modal-driver-phone');
      const driverWhatsEl = document.getElementById('ride-modal-whatsapp');
      const origemEl = document.getElementById('ride-modal-origem');
      const destinoEl = document.getElementById('ride-modal-destino');
      const seatsEl = document.getElementById('ride-modal-seats');
      const status = formatRideStatus(corrida.status);
      const normalized = normalizeRideStatus(corrida.status);
      const motorista = corrida.motorista || {};
      const showDriver = normalized === 'aceita' || normalized === 'em_andamento';
      const statusHint =
        normalized === 'aguardando'
          ? 'Aguardando confirmação do motorista.'
          : normalized === 'aceita'
            ? 'Motorista confirmado. A caminho da origem.'
            : normalized === 'em_andamento'
              ? 'Corrida em andamento.'
              : 'Status atualizado.';
      const origemText = corrida.origem_endereco || formatLatLng(corrida.origem_lat, corrida.origem_lng) || '—';
      const destinoText = corrida.destino_endereco || formatLatLng(corrida.destino_lat, corrida.destino_lng) || '—';

      if (statusEl) statusEl.textContent = status;
      if (statusHintEl) statusHintEl.textContent = statusHint;
      if (origemEl) origemEl.textContent = `Origem: ${origemText}`;
      if (destinoEl) destinoEl.textContent = `Destino: ${destinoText}`;
      if (seatsEl) seatsEl.textContent = `Lugares: ${formatSeats(corrida.lugares)}`;

      if (showDriver) {
        if (driverNameEl) driverNameEl.textContent = motorista.nome || 'Motorista confirmado';
        if (driverPhoneEl) driverPhoneEl.textContent = motorista.telefone || 'Telefone não informado';
        if (driverWhatsEl) {
          const link = buildWhatsAppLink(motorista.telefone);
          if (link) {
            driverWhatsEl.href = link;
            driverWhatsEl.classList.remove('d-none');
          } else {
            driverWhatsEl.href = '#';
            driverWhatsEl.classList.add('d-none');
          }
        }
      } else {
        if (driverNameEl) driverNameEl.textContent = 'Aguardando motorista aceitar';
        if (driverPhoneEl) driverPhoneEl.textContent = '—';
        if (driverWhatsEl) {
          driverWhatsEl.href = '#';
          driverWhatsEl.classList.add('d-none');
        }
      }
    }

    function clearRideModalDetails() {
      const statusEl = document.getElementById('ride-modal-status');
      const statusHintEl = document.getElementById('ride-modal-status-hint');
      const driverNameEl = document.getElementById('ride-modal-driver-name');
      const driverPhoneEl = document.getElementById('ride-modal-driver-phone');
      const driverWhatsEl = document.getElementById('ride-modal-whatsapp');
      const origemEl = document.getElementById('ride-modal-origem');
      const destinoEl = document.getElementById('ride-modal-destino');
      const seatsEl = document.getElementById('ride-modal-seats');
      const progressWrap = document.getElementById('ride-modal-cancel-progress');
      const progressBar = document.getElementById('ride-modal-cancel-progress-bar');
      const progressHint = document.getElementById('ride-modal-cancel-progress-hint');
      const finalizeWrap = document.getElementById('ride-modal-finalize-progress');
      const finalizeBar = document.getElementById('ride-modal-finalize-progress-bar');
      const finalizeHint = document.getElementById('ride-modal-finalize-progress-hint');
      const finalizeBtn = document.getElementById('modal-finalize-ride');
      if (statusEl) statusEl.textContent = 'Aguardando motorista';
      if (statusHintEl) statusHintEl.textContent = 'Aguardando confirmação do motorista.';
      if (driverNameEl) driverNameEl.textContent = 'Aguardando motorista aceitar';
      if (driverPhoneEl) driverPhoneEl.textContent = '—';
      if (driverWhatsEl) {
        driverWhatsEl.href = '#';
        driverWhatsEl.classList.add('d-none');
      }
      if (origemEl) origemEl.textContent = 'Origem: —';
      if (destinoEl) destinoEl.textContent = 'Destino: —';
      if (seatsEl) seatsEl.textContent = 'Lugares: —';
      if (progressWrap) progressWrap.classList.add('d-none');
      if (progressHint) progressHint.classList.add('d-none');
      if (progressBar) progressBar.style.width = '0%';
      if (progressHint) progressHint.textContent = '';
      if (finalizeWrap) finalizeWrap.classList.add('d-none');
      if (finalizeHint) finalizeHint.classList.add('d-none');
      if (finalizeBar) finalizeBar.style.width = '0%';
      if (finalizeHint) finalizeHint.textContent = '';
      if (finalizeBtn) finalizeBtn.classList.add('d-none');
      stopCancelUnlockTimer();
      stopFinalizeUnlockTimer();
    }

    function renderRideModal(corrida) {
      const backdrop = document.getElementById('ride-modal');
      const cancelBtn = document.getElementById('modal-cancel-ride');
      const finalizeBtn = document.getElementById('modal-finalize-ride');
      const hasRide = corrida && corrida.id && isActiveRideStatus(corrida.status);
      if (hasRide) {
        updateRideModalDetails(corrida);
        backdrop.style.display = 'flex';
        updateRideModalMap(corrida);
      } else {
        clearRideModalDetails();
        backdrop.style.display = 'none';
      }
      if (!hasRide && cancelBtn) cancelBtn.classList.add('d-none');
      if (!hasRide && finalizeBtn) finalizeBtn.classList.add('d-none');
      updateCancelUnlockUi();
      updateFinalizeUnlockUi();
    }

    function updateRideModalMap(corrida) {
      if (!hasLeaflet()) return;
      if (!state.rideModalMap) {
        state.rideModalMap = L.map('ride-modal-map', { zoomControl: false, attributionControl: false }).setView([-22.763, -43.106], 14);
        currentProvider = 0;
        tryNextProvider(state.rideModalMap);
      }
      const map = state.rideModalMap;
      let origem = null;
      let destino = null;
      let motorista = null;
      ['origem', 'destino', 'motorista'].forEach((k) => {
        if (state.rideModalMarkers[k]) {
          map.removeLayer(state.rideModalMarkers[k]);
          delete state.rideModalMarkers[k];
        }
      });
      const points = [];
      if (corrida.origem_lat && corrida.origem_lng) {
        origem = [Number(corrida.origem_lat), Number(corrida.origem_lng)];
        const marker = L.marker(origem, { title: 'Origem' }).addTo(map);
        state.rideModalMarkers.origem = marker;
        points.push(origem);
      }
      if (corrida.destino_lat && corrida.destino_lng) {
        destino = [Number(corrida.destino_lat), Number(corrida.destino_lng)];
        const marker = L.marker(destino, { title: 'Destino' }).addTo(map);
        state.rideModalMarkers.destino = marker;
        points.push(destino);
      }
      if (corrida.motorista_lat && corrida.motorista_lng) {
        motorista = [Number(corrida.motorista_lat), Number(corrida.motorista_lng)];
        const marker = L.marker(motorista, { title: 'Motorista' }).addTo(map);
        state.rideModalMarkers.motorista = marker;
        points.push(motorista);
      }
      ensureRoute(map, 'rideModal', 'ride', origem, destino);
      ensureRoute(map, 'rideModal', 'driver', motorista, origem);
      if (points.length) {
        const bounds = L.latLngBounds(points);
        map.fitBounds(bounds.pad(0.3));
      }
      setTimeout(() => map.invalidateSize(), 200);
    }

    function driverStatusHint(normalized) {
      if (normalized === 'aguardando') return 'Corrida aguardando sua confirmação.';
      if (normalized === 'aceita') return 'Siga até a origem e inicie a corrida.';
      if (normalized === 'em_andamento') return 'Leve o passageiro ao destino.';
      if (normalized === 'concluida') return 'Corrida concluída.';
      if (normalized === 'cancelada') return 'Corrida cancelada.';
      if (normalized === 'rejeitada') return 'Corrida rejeitada.';
      return 'Status atualizado.';
    }

    function updateDriverModalDetails(corrida) {
      const statusEl = document.getElementById('driver-modal-status');
      const statusHintEl = document.getElementById('driver-modal-status-hint');
      const passengerNameEl = document.getElementById('driver-modal-passenger-name');
      const passengerPhoneEl = document.getElementById('driver-modal-passenger-phone');
      const passengerWhatsEl = document.getElementById('driver-modal-whatsapp');
      const origemEl = document.getElementById('driver-modal-origem');
      const destinoEl = document.getElementById('driver-modal-destino');
      const seatsEl = document.getElementById('driver-modal-seats');
      const normalized = normalizeRideStatus(corrida.status);
      const status = formatRideStatus(corrida.status);
      const passageiro = corrida.cliente || {};
      const origemText = corrida.origem_endereco || formatLatLng(corrida.origem_lat, corrida.origem_lng) || '—';
      const destinoText = corrida.destino_endereco || formatLatLng(corrida.destino_lat, corrida.destino_lng) || '—';

      if (statusEl) statusEl.textContent = status;
      if (statusHintEl) statusHintEl.textContent = driverStatusHint(normalized);
      if (passengerNameEl) passengerNameEl.textContent = passageiro.nome || 'Passageiro confirmado';
      if (passengerPhoneEl) passengerPhoneEl.textContent = passageiro.telefone || 'Telefone não informado';
      if (passengerWhatsEl) {
        const link = buildWhatsAppLink(passageiro.telefone);
        if (link) {
          passengerWhatsEl.href = link;
          passengerWhatsEl.classList.remove('d-none');
        } else {
          passengerWhatsEl.href = '#';
          passengerWhatsEl.classList.add('d-none');
        }
      }
      if (origemEl) origemEl.textContent = `Origem: ${origemText}`;
      if (destinoEl) destinoEl.textContent = `Destino: ${destinoText}`;
      if (seatsEl) seatsEl.textContent = `Lugares: ${formatSeats(corrida.lugares)}`;
    }

    function clearDriverModalDetails() {
      const statusEl = document.getElementById('driver-modal-status');
      const statusHintEl = document.getElementById('driver-modal-status-hint');
      const passengerNameEl = document.getElementById('driver-modal-passenger-name');
      const passengerPhoneEl = document.getElementById('driver-modal-passenger-phone');
      const passengerWhatsEl = document.getElementById('driver-modal-whatsapp');
      const origemEl = document.getElementById('driver-modal-origem');
      const destinoEl = document.getElementById('driver-modal-destino');
      const seatsEl = document.getElementById('driver-modal-seats');
      if (statusEl) statusEl.textContent = 'Aguardando sua confirmação';
      if (statusHintEl) statusHintEl.textContent = 'Corrida aguardando sua confirmação.';
      if (passengerNameEl) passengerNameEl.textContent = '—';
      if (passengerPhoneEl) passengerPhoneEl.textContent = '—';
      if (passengerWhatsEl) {
        passengerWhatsEl.href = '#';
        passengerWhatsEl.classList.add('d-none');
      }
      if (origemEl) origemEl.textContent = 'Origem: —';
      if (destinoEl) destinoEl.textContent = 'Destino: —';
      if (seatsEl) seatsEl.textContent = 'Lugares: —';
    }

    function renderDriverModal(corrida) {
      const backdrop = document.getElementById('driver-ride-modal');
      const hasRide = corrida && corrida.id;
      if (hasRide) {
        updateDriverModalDetails(corrida);
        backdrop.style.display = 'flex';
        updateDriverModalMap(corrida);
      } else {
        clearDriverModalDetails();
        backdrop.style.display = 'none';
      }
    }

    function updateDriverModalMap(corrida) {
      if (!hasLeaflet()) return;
      if (!state.driverModalMap) {
        state.driverModalMap = L.map('driver-ride-modal-map', { zoomControl: false, attributionControl: false }).setView([-22.763, -43.106], 14);
        currentProvider = 0;
        tryNextProvider(state.driverModalMap);
      }
      const map = state.driverModalMap;
      let origem = null;
      let destino = null;
      let motorista = null;
      ['origem', 'destino', 'motorista'].forEach((k) => {
        if (state.driverModalMarkers[k]) {
          map.removeLayer(state.driverModalMarkers[k]);
          delete state.driverModalMarkers[k];
        }
      });
      const points = [];
      if (corrida.origem_lat && corrida.origem_lng) {
        origem = [Number(corrida.origem_lat), Number(corrida.origem_lng)];
        const marker = L.marker(origem, { title: 'Origem' }).addTo(map);
        state.driverModalMarkers.origem = marker;
        points.push(origem);
      }
      if (corrida.destino_lat && corrida.destino_lng) {
        destino = [Number(corrida.destino_lat), Number(corrida.destino_lng)];
        const marker = L.marker(destino, { title: 'Destino' }).addTo(map);
        state.driverModalMarkers.destino = marker;
        points.push(destino);
      }
      if (corrida.motorista_lat && corrida.motorista_lng) {
        motorista = [Number(corrida.motorista_lat), Number(corrida.motorista_lng)];
        const marker = L.marker(motorista, { title: 'Motorista' }).addTo(map);
        state.driverModalMarkers.motorista = marker;
        points.push(motorista);
      }
      ensureRoute(map, 'driverModal', 'ride', origem, destino);
      ensureRoute(map, 'driverModal', 'driver', motorista, origem);
      if (points.length) {
        const bounds = L.latLngBounds(points);
        map.fitBounds(bounds.pad(0.3));
      }
      setTimeout(() => map.invalidateSize(), 200);
    }

    async function driverAction(action) {
      const corrida = await fetchDriverRide();
      if (!corrida || !corrida.id) throw new Error('Nenhuma corrida ativa atribuída');
      const body = { motorista_id: state.user.perfil_id, perfil_id: state.user.perfil_id };
      const res = await api(`/api/corridas/${corrida.id}/${action}/`, { method: 'POST', body });
      renderDriverRide(res);
    }
    document.getElementById('btn-aceitar').addEventListener('click', async () => {
      try { await driverAction('aceitar'); } catch (e) { toast(e.message, true); }
    });
    document.getElementById('btn-rejeitar').addEventListener('click', async () => {
      try { await driverAction('rejeitar'); } catch (e) { toast(e.message, true); }
    });
    document.getElementById('btn-iniciar').addEventListener('click', async () => {
      try { await driverAction('iniciar'); } catch (e) { toast(e.message, true); }
    });
    document.getElementById('btn-finalizar').addEventListener('click', async () => {
      try { await driverAction('finalizar'); } catch (e) { toast(e.message, true); }
    });

    // Map
    const ROUTE_COLORS = {
      ride: '#0ea5e9',
      driver: '#f97316',
    };
    const ROUTE_MESH_TRIM_THRESHOLD_M = 10;

    function buildRouteKey(start, end) {
      if (!start || !end) return null;
      const fmt = (value) => Number(value).toFixed(6);
      return `${fmt(start[0])},${fmt(start[1])}|${fmt(end[0])},${fmt(end[1])}`;
    }

    function parseRoutePoints(data) {
      const raw = Array.isArray(data && data.route) ? data.route : [];
      return raw
        .map((point) => {
          if (Array.isArray(point) && point.length >= 2) {
            const lat = Number(point[0]);
            const lng = Number(point[1]);
            if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
            return [lat, lng];
          }
          if (point && typeof point === 'object') {
            const lat = Number(point.lat);
            const lng = Number(point.lng);
            if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
            return [lat, lng];
          }
          return null;
        })
        .filter(Boolean);
    }

    function parseRouteSnap(value) {
      const num = Number(value);
      return Number.isFinite(num) ? num : null;
    }

    async function fetchRoutePoints(start, end) {
      const params = new URLSearchParams({
        start_lat: start[0],
        start_lng: start[1],
        end_lat: end[0],
        end_lng: end[1],
      });
      const res = await fetch(`/api/geo/route/?${params.toString()}`, { credentials: 'include' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        const err = new Error(data.detail || res.statusText);
        err.status = res.status;
        throw err;
      }
      return {
        points: parseRoutePoints(data),
        closestStart: data.closest_road_start,
        closestEnd: data.closest_road_end,
        source: data.source,
        snapStart: parseRouteSnap(data.snap_start_m),
        snapEnd: parseRouteSnap(data.snap_end_m),
      };
    }

    function convertClosestRoad(entry) {
      if (!entry || !Array.isArray(entry.points)) return null;
      const values = entry.points
        .map((pt) => {
          if (!pt || typeof pt !== 'object') return null;
          const lat = Number(pt.lat);
          const lng = Number(pt.lng);
          if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
          return [lat, lng];
        })
        .filter(Boolean);
      return values.length >= 2 ? values : null;
    }

    function trimRouteToMesh(points, snapStart, snapEnd) {
      if (!Array.isArray(points) || points.length < 2) {
        return points;
      }
      const trimmed = points.slice();
      const startSnap = typeof snapStart === 'number' ? snapStart : 0;
      const endSnap = typeof snapEnd === 'number' ? snapEnd : 0;
      if (startSnap >= ROUTE_MESH_TRIM_THRESHOLD_M && trimmed.length > 1) {
        trimmed.shift();
      }
      if (endSnap >= ROUTE_MESH_TRIM_THRESHOLD_M && trimmed.length > 1) {
        trimmed.pop();
      }
      return trimmed.length >= 2 ? trimmed : points;
    }

    function chooseRoutePoints(result, start, end) {
      if (Array.isArray(result.points) && result.points.length >= 2) {
        const trimmed = trimRouteToMesh(result.points, result.snapStart, result.snapEnd);
        if (trimmed.length >= 2) {
          return trimmed;
        }
        return result.points;
      }
      const fallback =
        convertClosestRoad(result.closestStart) || convertClosestRoad(result.closestEnd);
      if (fallback) {
        return fallback;
      }
      const base = [];
      if (start) base.push(start);
      if (end) base.push(end);
      return base;
    }

    function clearRouteLayer(map, layerKey, routeKey) {
      if (!map) return;
      const existing = state.routeLayers[layerKey][routeKey];
      if (existing) {
        map.removeLayer(existing);
      }
      state.routeLayers[layerKey][routeKey] = null;
      state.routeKeys[layerKey][routeKey] = null;
    }

    function applyRouteLayer(map, layerKey, routeKey, points) {
      if (!map) return;
      const existing = state.routeLayers[layerKey][routeKey];
      if (existing) {
        map.removeLayer(existing);
      }
      if (!Array.isArray(points) || points.length < 2) {
        state.routeLayers[layerKey][routeKey] = null;
        return;
      }
      const polyline = L.polyline(points, {
        color: ROUTE_COLORS[routeKey] || ROUTE_COLORS.ride,
        weight: 4,
        opacity: 0.85,
        lineJoin: 'round',
        lineCap: 'round',
      });
      polyline.addTo(map);
      state.routeLayers[layerKey][routeKey] = polyline;
    }

    async function ensureRoute(map, layerKey, routeKey, start, end) {
      if (!map || !hasLeaflet()) return;
      if (!start || !end) {
        clearRouteLayer(map, layerKey, routeKey);
        return;
      }
      const key = buildRouteKey(start, end);
      if (state.routeKeys[layerKey][routeKey] === key) return;
      state.routeKeys[layerKey][routeKey] = key;
      const requestId = ++state.routeRequests[layerKey][routeKey];
      try {
        const result = await fetchRoutePoints(start, end);
        if (state.routeRequests[layerKey][routeKey] !== requestId) return;
        const displayPoints = chooseRoutePoints(result, start, end);
        applyRouteLayer(map, layerKey, routeKey, displayPoints);
      } catch (e) {
        console.warn('Falha ao calcular rota', e);
        if (state.routeRequests[layerKey][routeKey] !== requestId) return;
        applyRouteLayer(map, layerKey, routeKey, [start, end]);
      }
    }

    function hasLeaflet() {
      if (typeof L === 'undefined') {
        console.warn('Leaflet não carregou (sem rede?). Mapa desativado.');
        document.getElementById('map-status').textContent = 'Mapa indisponível (verifique sua conexão).';
        return false;
      }
      return true;
    }

    const TILE_PROVIDERS = [
      // Offline/embarcado
      { url: '/static/landing/assets/tiles/{z}/{x}/{y}.png', attribution: 'Tiles locais', local: true, minZoom: 12, maxZoom: 19 },
      // Online
      { url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attribution: '&copy; OpenStreetMap' },
      { url: 'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', attribution: '&copy; OpenStreetMap contributors' },
      { url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', attribution: '&copy; OSM & Carto' },
    ];

    let currentProvider = 0;

    function tryNextProvider(map) {
      if (currentProvider >= TILE_PROVIDERS.length) {
        document.getElementById('map-status').textContent = 'Tiles indisponíveis. Verifique a conexão.';
        return;
      }
      const prov = TILE_PROVIDERS[currentProvider];
      currentProvider += 1;
      try {
        const layer = L.tileLayer(prov.url, {
          maxZoom: prov.maxZoom || 19,
          minZoom: prov.minZoom || 0,
          attribution: prov.attribution,
          noWrap: true,
          errorTileUrl: "{% static 'leaflet/images/marker-icon.png' %}", /* fallback visual */
        });
        layer.on('tileerror', () => {
          if (prov.local) {
            document.getElementById('map-status').textContent = 'Alguns tiles locais faltando; verifique se o mapa está completo.';
            return; // não remove camada local
          }
          document.getElementById('map-status').textContent = 'Falha ao carregar tiles, tentando outro provedor...';
          map.removeLayer(layer);
          tryNextProvider(map);
        });
        layer.on('load', () => {
          document.getElementById('map-status').textContent = 'Origem/destino serão exibidos aqui.';
        });
        layer.addTo(map);
      } catch (e) {
        console.warn('Erro ao carregar tiles', e);
        tryNextProvider(map);
      }
    }

    function initMap(force) {
      if (state.map && !force) return;
      if (!hasLeaflet()) return;
      const fallback = [-22.763, -43.106];
      state.map = L.map('map').setView(fallback, 14);
      // Limita à área de Paquetá para evitar tiles fora do recorte local
      state.map.setMaxBounds([[-22.78, -43.13], [-22.74, -43.08]]);
      currentProvider = 0;
      tryNextProvider(state.map);
      setTimeout(() => state.map && state.map.invalidateSize(), 200);
    }

    function updateMapFromRide(corrida) {
      if (!state.map) initMap();
      if (!state.map) return;
      ['origem', 'destino', 'motorista'].forEach((k) => {
        if (state.markers[k]) {
          state.map.removeLayer(state.markers[k]);
          delete state.markers[k];
        }
      });
      if (!corrida) {
        const statusEl = document.getElementById('map-status');
        if (statusEl) statusEl.textContent = 'Origem/destino serão exibidos aqui.';
        clearRouteLayer(state.map, 'main', 'ride');
        clearRouteLayer(state.map, 'main', 'driver');
        return;
      }
      const points = [];
      let origem = null;
      let destino = null;
      let motorista = null;
      if (corrida.origem_lat && corrida.origem_lng) {
        origem = [Number(corrida.origem_lat), Number(corrida.origem_lng)];
        const marker = L.marker(origem, { title: 'Origem' }).addTo(state.map);
        marker.bindPopup('Origem');
        state.markers.origem = marker;
        points.push(origem);
      }
      if (corrida.destino_lat && corrida.destino_lng) {
        destino = [Number(corrida.destino_lat), Number(corrida.destino_lng)];
        const marker = L.marker(destino, { title: 'Destino' }).addTo(state.map);
        marker.bindPopup('Destino');
        state.markers.destino = marker;
        points.push(destino);
      }
      if (corrida.motorista_lat && corrida.motorista_lng) {
        motorista = [Number(corrida.motorista_lat), Number(corrida.motorista_lng)];
        const marker = L.marker(motorista, {
          title: 'Motorista',
          icon: L.icon({
            iconUrl: "{% static 'leaflet/images/marker-icon.png' %}",
            shadowUrl: "{% static 'leaflet/images/marker-shadow.png' %}",
          }),
        }).addTo(state.map);
        marker.bindPopup('Motorista');
        state.markers.motorista = marker;
        points.push(motorista);
      }
      ensureRoute(state.map, 'main', 'ride', origem, destino);
      ensureRoute(state.map, 'main', 'driver', motorista, origem);
      if (points.length) {
        const bounds = L.latLngBounds(points);
        state.map.fitBounds(bounds.pad(0.3));
        const statusEl = document.getElementById('map-status');
        if (statusEl) statusEl.textContent = '';
      } else {
        const statusEl = document.getElementById('map-status');
        if (statusEl) statusEl.textContent = 'Origem/destino serão exibidos aqui.';
      }
    }

    // Auto ping para eco-taxista
    async function sendPing(lat, lng, precisao) {
      if (!state.user?.perfil_id) throw new Error('Sem perfil logado');
      const latNorm = parseCoord(lat);
      const lngNorm = parseCoord(lng);
      if (!latNorm || !lngNorm) throw new Error('Coordenadas inválidas para ping');
      updateDriverLocation(Number(latNorm), Number(lngNorm));
      const body = {
        perfil: state.user.perfil_id,
        latitude: latNorm,
        longitude: lngNorm,
      };
      if (precisao !== undefined) body.precisao_m = precisao;
      setDriverGpsSending(true);
      try {
        await api('/api/pings/', { method: 'POST', body });
      } finally {
        setDriverGpsSending(false);
      }
    }

    function stopAutoPing() {
      if (state.watchId && navigator.geolocation) {
        navigator.geolocation.clearWatch(state.watchId);
        state.watchId = null;
      }
      updateDriverGpsStatus({ status: 'GPS pausado', lastSent: null });
    }

    function ensureAutoPing() {
      stopAutoPing();
      if (!state.user || state.user.perfil_tipo !== 'ecotaxista') return;
      if (!navigator.geolocation) {
        toast('Geolocalização não suportada. Insira a posição manualmente.');
        updateDriverGpsStatus({ status: 'GPS indisponível', lastSent: null });
        return;
      }
      updateDriverGpsStatus({ status: 'Ativando GPS...' });
      state.watchId = navigator.geolocation.watchPosition(
        async (pos) => {
          try {
            const coords = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
            updateDriverGpsStatus({ status: 'Enviando localização...', coords });
            await sendPing(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy);
            const sentAt = new Date().toLocaleTimeString('pt-BR');
            updateDriverGpsStatus({ status: 'GPS ativo', lastSent: sentAt });
          } catch (e) {
            console.warn('Falha ao enviar ping automático', e);
            updateDriverGpsStatus({ status: 'Falha ao enviar localização' });
          }
        },
        (err) => {
          toast('Permita o GPS para enviar sua posição automática. Sem permissão, você pode enviar manualmente sua localização.', true);
          updateDriverGpsStatus({ status: 'GPS desativado', lastSent: null });
        },
        { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
      );
    }

    function initWebappHeader() {
      const header = document.querySelector('.navbar-area');
      if (!header) return;
      const toggler = header.querySelector('.mobile-menu-btn');
      if (toggler) {
        toggler.addEventListener('click', () => {
          toggler.classList.toggle('active');
        });
      }
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      initWebappHeader();
      initMap(true);
      loadSession();
      enforceRoleTabs();
      loadAddresses();
      // tenta já pegar a origem via GPS, sem toast inicial
      requestOriginGps({ silent: true, suppressSuccess: true });
      ensureAutoPing();
      ensurePassengerPolling();
      ensureDriverPolling();
    });

    const enableGpsBtn = document.getElementById('btn-enable-gps');
    if (enableGpsBtn) {
      enableGpsBtn.addEventListener('click', () => ensureAutoPing());
    }

    const toggleManualBtn = document.getElementById('btn-toggle-manual');
    if (toggleManualBtn) {
      toggleManualBtn.addEventListener('click', () => {
        const manualForm = document.getElementById('driver-manual-form');
        if (!manualForm) return;
        manualForm.classList.toggle('d-none');
        toggleManualBtn.textContent = manualForm.classList.contains('d-none') ? 'Enviar manualmente' : 'Ocultar envio manual';
      });
    }

    // Polling de corrida para passageiro
    function ensurePassengerPolling() {
      if (state.ridePolling) {
        clearInterval(state.ridePolling);
        state.ridePolling = null;
      }
      if (state.user && state.user.perfil_tipo === 'passageiro') {
        // consulta imediata para exibir modal/mapa assim que logar ou trocar de perfil
        fetchPassengerRide().catch((e) => console.warn('Polling passageiro (imediato) falhou', e));
        state.ridePolling = setInterval(() => {
          fetchPassengerRide().catch((e) => console.warn('Polling passageiro falhou', e));
        }, 4000);
      } else {
        renderRideModal(null);
        state.activePassengerRide = null;
      }
    }

    function ensureDriverPolling() {
      if (state.driverRidePolling) {
        clearInterval(state.driverRidePolling);
        state.driverRidePolling = null;
      }
      if (state.user && state.user.perfil_tipo === 'ecotaxista') {
        fetchDriverRide().catch((e) => console.warn('Polling motorista (imediato) falhou', e));
        state.driverRidePolling = setInterval(() => {
          fetchDriverRide().catch((e) => console.warn('Polling motorista falhou', e));
        }, 4000);
      } else {
        renderDriverModal(null);
        state.activeDriverRide = null;
      }
    }

    // Cancelar corrida via modal
    document.getElementById('modal-cancel-ride').addEventListener('click', async () => {
      try {
        const corrida = await api(`/api/corridas/para_passageiro/${state.user.perfil_id}/`);
        if (!corrida || !corrida.id) return toast('Nenhuma corrida ativa para cancelar', true);
        renderPassengerRide(corrida);
        const remaining = cancelUnlockRemainingMs(corrida);
        if (normalizeRideStatus(corrida.status) === 'aceita' && remaining > 0) {
          updateCancelUnlockUi();
          return toast(`Aguarde ${formatRemainingMs(remaining)} para cancelar.`, true);
        }
        const res = await api(`/api/corridas/${corrida.id}/cancelar/`, { method: 'POST', body: { perfil_id: state.user.perfil_id } });
        state.activePassengerRide = null;
        renderPassengerRide(res);
      } catch (e) {
        toast(e.message, true);
      }
    });

    // Finalizar corrida via modal (passageiro)
    document.getElementById('modal-finalize-ride').addEventListener('click', async () => {
      try {
        const corrida = await api(`/api/corridas/para_passageiro/${state.user.perfil_id}/`);
        if (!corrida || !corrida.id) return toast('Nenhuma corrida ativa para finalizar', true);
        renderPassengerRide(corrida);
        const remaining = finalizeUnlockRemainingMs(corrida);
        if (normalizeRideStatus(corrida.status) === 'em_andamento' && remaining > 0) {
          updateFinalizeUnlockUi();
          return toast(`Aguarde ${formatRemainingMs(remaining)} para finalizar.`, true);
        }
        if (normalizeRideStatus(corrida.status) !== 'em_andamento') {
          updateFinalizeUnlockUi();
          return;
        }
        const res = await api(`/api/corridas/${corrida.id}/finalizar/`, { method: 'POST' });
        state.activePassengerRide = null;
        renderPassengerRide(res);
        renderRideModal(null);
      } catch (e) {
        toast(e.message, true);
      }
    });

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register("{% url 'webapp_sw' %}", { scope: '/app/' })
          .catch((err) => console.warn('Falha ao registrar Service Worker', err));
      });
    }
  </script>
</body>
</html>
